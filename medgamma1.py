# -*- coding: utf-8 -*-
"""medGamma1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1J4TMKwnlbXsbjwp4tBf8QhCGIptCYump

#test

#t1
"""

!pip install -q transformers accelerate sentencepiece torch

from huggingface_hub import notebook_login
notebook_login()

from huggingface_hub import whoami
whoami()



import torch
import json
import re
import sys
from transformers import AutoTokenizer, AutoModelForCausalLM

# -----------------------------
# CONFIG
# -----------------------------
MODEL_NAME = "google/medgemma-4b-it"
device = "cuda" if torch.cuda.is_available() else "cpu"

def load_model():
    print(f"Loading model {MODEL_NAME} on {device}...")
    tokenizer = AutoTokenizer.from_pretrained(MODEL_NAME)
    model = AutoModelForCausalLM.from_pretrained(
        MODEL_NAME,
        torch_dtype=torch.float16 if device == "cuda" else torch.float32,
        device_map="auto"
    )
    return tokenizer, model

tokenizer, model = load_model()

# -----------------------------
# QUESTION DATA STRUCTURE
# -----------------------------
QUESTIONS = {
    "General": {
        "Q1": {
            "en": "What is the child‚Äôs age?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥µ‡¥Ø‡¥∏‡µç ‡¥é‡¥§‡µç‡¥∞‡¥Ø‡¥æ‡¥£‡µç?",
            "type": "number", "min": 6, "max": 12,
            "context": lambda v: f"The child is {v} years old."
        },
        "Q2": {
            "en": "How long has the problem been present?",
            "ml": "‡¥à ‡¥™‡µç‡¥∞‡¥∂‡µç‡¥®‡¥Ç ‡¥é‡¥§‡µç‡¥∞ ‡¥¶‡¥ø‡¥µ‡¥∏‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥§‡µÅ‡¥ü‡¥∞‡µÅ‡¥®‡µç‡¥®‡µÅ?",
            "type": "radio",
            "options": {
                "< 1 day": {"en": "< 1 day", "ml": "1 ‡¥¶‡¥ø‡¥µ‡¥∏‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥§‡¥æ‡¥¥‡µÜ"},
                "1‚Äì2 days": {"en": "1‚Äì2 days", "ml": "1-2 ‡¥¶‡¥ø‡¥µ‡¥∏‡¥Ç"},
                "3+ days": {"en": "3+ days", "ml": "3 ‡¥¶‡¥ø‡¥µ‡¥∏‡¥§‡µç‡¥§‡¥ø‡¥≤‡¥ß‡¥ø‡¥ï‡¥Ç"}
            },
            "context": {
                "< 1 day": "The symptoms started recently (less than 24 hours ago).",
                "1‚Äì2 days": "The symptoms have been present for 1 to 2 days.",
                "3+ days": "The symptoms have persisted for more than 3 days."
            }
        },
        "Q3": {
            "en": "Is the child unusually drowsy, confused, or not responding normally?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥Ö‡¥∏‡¥æ‡¥ß‡¥æ‡¥∞‡¥£‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥â‡¥±‡¥ï‡µç‡¥ï‡¥Æ‡µÅ‡¥≥‡µç‡¥≥‡¥§‡µã ‡¥™‡µç‡¥∞‡¥§‡¥ø‡¥ï‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥§‡µç‡¥§‡¥§‡µã ‡¥Ü‡¥£‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child is showing signs of altered consciousness, unusual drowsiness, or confusion.",
                "No": "The child is alert and responding normally to surroundings."
            }
        },
        "Q4": {
            "en": "Is the child able to drink and keep fluids down?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥µ‡µÜ‡¥≥‡µç‡¥≥‡¥Ç ‡¥ï‡µÅ‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥®‡µÅ‡¥Ç ‡¥®‡¥ø‡¥≤‡¥®‡¥ø‡µº‡¥§‡µç‡¥§‡¥æ‡¥®‡µÅ‡¥Ç ‡¥ï‡¥¥‡¥ø‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is able to tolerate oral fluids and maintain hydration.",
                "No": "The child is unable to drink or keep any fluids down, risking dehydration."
            }
        },
        "Q5": {
            "en": "Does the child have asthma, diabetes, heart disease, or other chronic illness?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥Ü‡¥∏‡µç‡¥§‡µç‡¥Æ, ‡¥™‡µç‡¥∞‡¥Æ‡µá‡¥π‡¥Ç, ‡¥π‡µÉ‡¥¶‡µç‡¥∞‡µã‡¥ó‡¥Ç ‡¥§‡µÅ‡¥ü‡¥ô‡µç‡¥ô‡¥ø‡¥Ø ‡¥¶‡µÄ‡µº‡¥ò‡¥ï‡¥æ‡¥≤ ‡¥∞‡µã‡¥ó‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child has a pre-existing chronic medical condition (e.g., asthma, diabetes).",
                "No": "The child has no known chronic underlying illnesses."
            }
        },
    },
    "Cold / Cough / Fever": {

        "Q6": {
            "en": "How does the fever feel?",
            "ml": "‡¥™‡¥®‡¥ø ‡¥é‡¥ô‡µç‡¥ô‡¥®‡µÜ ‡¥§‡µã‡¥®‡µç‡¥®‡µÅ‡¥®‡µç‡¥®‡µÅ?",
            "type": "radio",
            "options": {
                "Warm but child active": {"en": "Warm but child active", "ml": "‡¥ö‡µÜ‡¥±‡¥ø‡¥Ø ‡¥™‡¥®‡¥ø, ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥â‡¥®‡µç‡¥Æ‡µá‡¥∑‡¥µ‡¥æ‡¥®‡¥æ‡¥£‡µç"},
                "Hot and uncomfortable": {"en": "Hot and uncomfortable", "ml": "‡¥∂‡¥∞‡µÄ‡¥∞‡¥Ç ‡¥®‡¥®‡µç‡¥®‡¥æ‡¥Ø‡¥ø ‡¥ö‡µÇ‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µç, ‡¥Ü‡¥∏‡µç‡¥µ‡¥∏‡µç‡¥•‡¥§‡¥Ø‡µÅ‡¥£‡µç‡¥ü‡µç"},
                "Very hot and child weak": {"en": "Very hot and child weak", "ml": "‡¥ï‡¥†‡¥ø‡¥®‡¥Æ‡¥æ‡¥Ø ‡¥™‡¥®‡¥ø, ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥µ‡¥≥‡¥∞‡µÜ ‡¥Ö‡¥µ‡¥∂‡¥®‡¥æ‡¥£‡µç"}
            },
            "context": {
                "Warm but child active": "Mild fever with normal activity.",
                "Hot and uncomfortable": "Moderate fever.",
                "Very hot and child weak": "High fever affecting the child."
            }
        },
        "Q7": {
            "en": "Has the fever lasted more than 3 days?",
            "ml": "‡¥™‡¥®‡¥ø 3 ‡¥¶‡¥ø‡¥µ‡¥∏‡¥§‡µç‡¥§‡¥ø‡¥≤‡¥ß‡¥ø‡¥ï‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥§‡µÅ‡¥ü‡¥∞‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The fever has been prolonged, lasting more than 72 hours.",
                "No": "The fever is recent and has lasted less than 3 days."
            }
        },
        "Q8": {
            "en": "Is there a rash on the body?",
            "ml": "‡¥∂‡¥∞‡µÄ‡¥∞‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥ö‡µä‡¥±‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥≤‡µã ‡¥ö‡µº‡¥Æ‡µç‡¥Æ‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥™‡¥æ‡¥ü‡µÅ‡¥ï‡¥≥‡µã ‡¥â‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "A new skin rash or spots have appeared on the child's body.",
                "No": "There is no visible rash on the skin."
            }
        },
        "Q9": {
            "en": "Is the child unable to bend the neck forward?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥ï‡¥¥‡µÅ‡¥§‡µç‡¥§‡µç ‡¥Æ‡µÅ‡¥®‡µç‡¥®‡µã‡¥ü‡µç‡¥ü‡µç ‡¥ï‡µÅ‡¥®‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥®‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥ø‡¥≤‡µç‡¥≤‡µá?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child is experiencing neck stiffness (meningismus), unable to touch chin to chest.",
                "No": "The child has normal neck mobility."
            }
        },
    },
    "Stomach Pain / Diarrhea / Vomiting": {
        "Q10": {
            "en": "How many times has the child vomited in the last 24 hours?",
            "ml": "‡¥ï‡¥¥‡¥ø‡¥û‡µç‡¥û 24 ‡¥Æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÇ‡¥±‡¥ø‡µΩ ‡¥é‡¥§‡µç‡¥∞ ‡¥§‡¥µ‡¥£ ‡¥õ‡µº‡¥¶‡µç‡¥¶‡¥ø‡¥ö‡µç‡¥ö‡µÅ?",
            "type": "radio",
            "options": {
                "None": {"en": "None", "ml": "‡¥í‡¥®‡µç‡¥®‡µÅ‡¥Æ‡¥ø‡¥≤‡µç‡¥≤"},
                "1-3": {"en": "1-3", "ml": "1-3 ‡¥§‡¥µ‡¥£"},
                "4+": {"en": "4+", "ml": "4 ‡¥§‡¥µ‡¥£‡¥Ø‡¥ø‡µΩ ‡¥ï‡µÇ‡¥ü‡µÅ‡¥§‡µΩ"}
            },
            "context": {
                "None": "The child has not vomited in the last 24 hours.",
                "1-3": "The child has vomited 1 to 3 times recently.",
                "4+": "The child is experiencing frequent/excessive vomiting (4 or more times)."
            }
        },
        "Q11": {
            "en": "Is there blood in vomit or stool?",
            "ml": "‡¥õ‡µº‡¥¶‡µç‡¥¶‡¥ø‡¥Ø‡¥ø‡¥≤‡µã ‡¥Æ‡¥≤‡¥§‡µç‡¥§‡¥ø‡¥≤‡µã ‡¥∞‡¥ï‡µç‡¥§‡¥Ç ‡¥â‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "Visible blood is present in the child's vomit or bowel movements.",
                "No": "There is no blood observed in vomit or stool."
            }
        },
        "Q12": {
            "en": "Is the stomach pain severe and constant?",
            "ml": "‡¥µ‡¥Ø‡¥±‡µÅ‡¥µ‡µá‡¥¶‡¥® ‡¥ï‡¥†‡¥ø‡¥®‡¥µ‡µÅ‡¥Ç ‡¥∏‡µç‡¥•‡¥ø‡¥∞‡¥µ‡µÅ‡¥Æ‡¥æ‡¥£‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is reporting intense, continuous abdominal pain.",
                "No": "Abdominal pain is absent or only mild/intermittent."
            }
        },
        "Q13": {
            "en": "Has the child passed urine in the last 8 hours?",
            "ml": "‡¥ï‡¥¥‡¥ø‡¥û‡µç‡¥û 8 ‡¥Æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÇ‡¥±‡¥ø‡µΩ ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥Æ‡µÇ‡¥§‡µç‡¥∞‡¥Æ‡µä‡¥¥‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child has normal urine output.",
                "No": "The child has not urinated for over 8 hours, indicating potential dehydration."
            }
        },
    },
    "Breathing Problem": {
        "Q14": {
            "en": "Is the child breathing faster than usual?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥∏‡¥æ‡¥ß‡¥æ‡¥∞‡¥£‡¥Ø‡µá‡¥ï‡µç‡¥ï‡¥æ‡µæ ‡¥µ‡µá‡¥ó‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥∂‡µç‡¥µ‡¥∏‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is showing tachypnea (increased breathing rate).",
                "No": "The child's breathing rate is within the normal range."
            }
        },
        "Q15": {
            "en": "Is the chest pulling in while breathing?",
            "ml": "‡¥∂‡µç‡¥µ‡¥∏‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥Æ‡µç‡¥™‡µã‡µæ ‡¥®‡µÜ‡¥û‡µç‡¥ö‡µç ‡¥â‡¥≥‡µç‡¥≥‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥µ‡¥≤‡¥ø‡¥ï‡µç‡¥ï‡¥™‡µç‡¥™‡µÜ‡¥ü‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child has chest retractions (respiratory distress), where the skin pulls in around the ribs.",
                "No": "The child is breathing easily without visible retractions."
            }
        },
        "Q16": {
            "en": "Are the lips or face turning bluish?",
            "ml": "‡¥ö‡µÅ‡¥£‡µç‡¥ü‡µÅ‡¥ï‡¥≥‡µã ‡¥Æ‡µÅ‡¥ñ‡¥Æ‡µã ‡¥®‡µÄ‡¥≤ ‡¥®‡¥ø‡¥±‡¥§‡µç‡¥§‡¥ø‡¥≤‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "Cyanosis is present: The child's lips or face have a blue tint, indicating low oxygen.",
                "No": "The child has normal skin/lip coloration."
            }
        },
        "Q17": {
            "en": "Is the child unable to speak full sentences due to breathlessness?",
            "ml": "‡¥∂‡µç‡¥µ‡¥æ‡¥∏‡¥Ç ‡¥Æ‡µÅ‡¥ü‡µç‡¥ü‡¥≤‡¥æ‡µΩ ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥™‡µÇ‡µº‡¥£‡µç‡¥£ ‡¥µ‡¥æ‡¥ö‡¥ï‡¥Ç ‡¥™‡¥±‡¥Ø‡¥æ‡¥®‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥ø‡¥≤‡µç‡¥≤‡µá?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is showing severe breathlessness, unable to speak in full sentences.",
                "No": "The child can speak normally without significant shortness of breath."
            }
        },
    },
    "Body Pain / Headache": {
        "Q18": {
            "en": "Is the headache or body pain severe ?",
            "ml": "‡¥§‡¥≤‡¥µ‡µá‡¥¶‡¥®‡¥Ø‡µã ‡¥∂‡¥∞‡µÄ‡¥∞‡¥µ‡µá‡¥¶‡¥®‡¥Ø‡µã ‡¥ï‡µÇ‡¥ü‡µÅ‡¥§‡¥≤‡¥æ‡¥£‡µã ?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is in severe headache or body pain.",
                "No": "The child is experiencing mild to moderate pain."
            }
        },
        "Q19": {
            "en": "Did the child have a head injury recently?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥ü‡µÅ‡¥§‡µç‡¥§‡¥ø‡¥ü‡µÜ ‡¥§‡¥≤‡¥ï‡µç‡¥ï‡µç ‡¥™‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥£‡µç‡¥ü‡¥æ‡¥Ø‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "There is a history of recent trauma or injury to the head.",
                "No": "There has been no recent head injury."
            }
        },
        "Q20": {
            "en": "Is there repeated vomiting with headache?",
            "ml": "‡¥§‡¥≤‡¥µ‡µá‡¥¶‡¥®‡¥Ø‡µã‡¥ü‡µä‡¥™‡µç‡¥™‡¥Ç ‡¥Ü‡¥µ‡µº‡¥§‡µç‡¥§‡¥ø‡¥ö‡µç‡¥ö ‡¥õ‡µº‡¥¶‡µç‡¥¶‡¥ø‡¥Ø‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child has a headache accompanied by persistent vomiting.",
                "No": "The headache is not associated with vomiting."
            }
        },
    },
    "Critical Red-Flags": {
        "Q21": {
            "en": "Has the child had a seizure?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥™‡¥∏‡µç‡¥Æ‡¥æ‡¥∞‡¥Ç ‡¥â‡¥£‡µç‡¥ü‡¥æ‡¥Ø‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child has experienced a seizure or convulsion.",
                "No": "The child has had no seizures."
            }
        },
        "Q22": {
            "en": "Has the child fainted or become unconscious?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥¨‡µã‡¥ß‡¥∞‡¥π‡¥ø‡¥§‡¥®‡¥æ‡¥Ø‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child has experienced loss of consciousness or fainting.",
                "No": "The child has remained conscious throughout."
            }
        },
        "Q23": {
            "en": "Is there a severe injury or heavy bleeding?",
            "ml": "‡¥ó‡µÅ‡¥∞‡µÅ‡¥§‡¥∞‡¥Æ‡¥æ‡¥Ø ‡¥™‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µã ‡¥∞‡¥ï‡µç‡¥§‡¥∏‡µç‡¥∞‡¥æ‡¥µ‡¥Æ‡µã ‡¥â‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child has sustained a major injury or is actively bleeding heavily.",
                "No": "There is no severe injury or heavy bleeding noted."
            }
        },
    }
}

# -----------------------------
# HOME CARE ADVICE LIBRARY
# -----------------------------
HOME_ADVICE_LIBRARY = {
    "REST": {
        "en": "Ensure the child gets adequate rest.",
        "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥§‡µç‡¥§‡¥ø‡¥®‡µç ‡¥µ‡¥ø‡¥∂‡µç‡¥∞‡¥Æ‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï."
    },
    "FLUIDS": {
        "en": "Encourage frequent intake of clean fluids like water or coconut water.",
        "ml": "‡¥µ‡µÜ‡¥≥‡µç‡¥≥‡¥Ç, ‡¥á‡¥≥‡¥®‡µÄ‡µº ‡¥§‡µÅ‡¥ü‡¥ô‡µç‡¥ô‡¥ø‡¥Ø ‡¥™‡¥æ‡¥®‡µÄ‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥ß‡¥æ‡¥∞‡¥æ‡¥≥‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï."
    },
    "LIGHT_DIET": {
        "en": "Provide light, easily digestible food.",
        "ml": "‡¥≤‡¥ò‡µÅ‡¥µ‡¥æ‡¥Ø‡¥§‡µÅ‡¥Ç ‡¥é‡¥≥‡µÅ‡¥™‡µç‡¥™‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥¶‡¥π‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥§‡µÅ‡¥Æ‡¥æ‡¥Ø ‡¥≠‡¥ï‡µç‡¥∑‡¥£‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï."
    },
    "HYGIENE": {
        "en": "Maintain proper hand hygiene to prevent spread of infection.",
        "ml": "‡¥Ö‡¥£‡µÅ‡¥¨‡¥æ‡¥ß ‡¥™‡¥ü‡¥∞‡¥æ‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡µª ‡¥ï‡µà‡¥ï‡µæ ‡¥µ‡µÉ‡¥§‡µç‡¥§‡¥ø‡¥Ø‡¥æ‡¥Ø‡¥ø ‡¥∏‡µÇ‡¥ï‡µç‡¥∑‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."
    },
    "MONITOR_SYMPTOMS": {
        "en": "Monitor symptoms closely for any worsening.",
        "ml": "‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ ‡¥ï‡µÇ‡¥ü‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã ‡¥é‡¥®‡µç‡¥®‡µç ‡¥∂‡µç‡¥∞‡¥¶‡µç‡¥ß‡¥æ‡¥™‡µÇ‡µº‡¥µ‡µç‡¥µ‡¥Ç ‡¥®‡¥ø‡¥∞‡µÄ‡¥ï‡µç‡¥∑‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."
    },
    "TEMPERATURE_CHECK": {
        "en": "Check temperature periodically if fever is present.",
        "ml": "‡¥™‡¥®‡¥ø ‡¥â‡¥£‡µç‡¥ü‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥ï‡µÉ‡¥§‡µç‡¥Ø‡¥∏‡¥Æ‡¥Ø‡¥§‡µç‡¥§‡µç ‡¥§‡¥æ‡¥™‡¥®‡¥ø‡¥≤ ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."
    }
}

# -----------------------------
# HARD RED FLAG CHECK
# -----------------------------
def check_red_flags(answers):
    critical_data = {
        "triage_level": "RED",
        "reasoning": "Immediate medical attention required for life-threatening symptoms flagged by critical clinical rules.",
        "confidence": "High (Rule-based Override)",
        "home_advice": []
    }

    # Rule 1: Direct Critical Questions (Q21, Q22, Q23)
    if any(answers.get(q) == "Yes" for q in ["Q21", "Q22", "Q23"]):
        return critical_data
    # Rule 2: Q3 (Not responding)
    if answers.get("Q3") == "Yes":
        return critical_data
    # Rule 3: Q9 (Neck Stiffness standalone)
    if answers.get("Q9") == "Yes":
        return critical_data
    # Rule 4: Q11 (Blood in vomit/stool)
    if answers.get("Q11") == "Yes":
        return critical_data
    # Rule 5: Q15/Q16 (Chest pulling / Bluish)
    if answers.get("Q15") == "Yes" or answers.get("Q16") == "Yes":
        return critical_data
    # Rule 6: Head injury + Vomiting (Q19 + Q20)
    if answers.get("Q19") == "Yes" and (answers.get("Q20") == "Yes" or answers.get("Q10", "") == "4+"):
        return critical_data

    # Rule 7: Chronic illness + Breathing distress (Q5 + Q14)
    if answers.get("Q5") == "Yes" and answers.get("Q14") == "Yes":
        return critical_data

    # Rule 8: Dehydration Risk (No urine + Vomiting) (Q13 + Q10)
    if answers.get("Q13") == "No" and answers.get("Q10", "None") != "None":
        return critical_data

    # Rule 9: Severe Pain + Fever Combination (Q18 + Q6)
    if answers.get("Q18") == "Yes" and answers.get("Q6") is not None:
        return critical_data

    return None

# -----------------------------
# BUILD STRUCTURED SUMMARY
# -----------------------------
def build_summary(answers):
    summary = "Pediatric Clinical Assessment (Age 6-12):\n"
    for cat, qs in QUESTIONS.items():
        cat_summary = ""
        for q_id, q_data in qs.items():
            val = answers.get(q_id)
            if val is not None:
                # Use context mapping if available
                if "context" in q_data:
                    if callable(q_data["context"]):
                        desc = q_data["context"](val)
                    elif isinstance(q_data["context"], dict):
                        desc = q_data["context"].get(val, f"{q_data['en']}: {val}")
                    else:
                        desc = f"{q_data['en']}: {val}"
                else:
                    desc = f"{q_data['en']}: {val}"
                cat_summary += f"- {desc}\n"

        if cat_summary:
            summary += f"\n### {cat}\n{cat_summary}"
    return summary

# -----------------------------
# MEDGEMMA CLASSIFICATION & EXTRACTION
# -----------------------------
REQUIRED_KEYS = {"triage_level", "reasoning", "confidence", "home_advice"}
VALID_ADVICE = {
    "REST",
    "FLUIDS",
    "LIGHT_DIET",
    "HYGIENE",
    "MONITOR_SYMPTOMS",
    "TEMPERATURE_CHECK"
}
VALID_TRIAGE = {"RED", "YELLOW", "GREEN"}

def extract_json_response(response_text: str):
    """
    Safely extract first valid JSON object from model output.
    """
    # 1Ô∏è‚É£ Remove markdown wrappers if present
    cleaned = response_text.strip()
    cleaned = cleaned.replace("```json", "").replace("```", "").strip()

    # 2Ô∏è‚É£ Find first balanced JSON block
    start = cleaned.find("{")
    if start == -1:
        raise ValueError("No JSON object found")

    brace_count = 0
    for i in range(start, len(cleaned)):
        if cleaned[i] == "{":
            brace_count += 1
        elif cleaned[i] == "}":
            brace_count -= 1

        if brace_count == 0:
            json_str = cleaned[start:i+1]
            break
    else:
        raise ValueError("Incomplete JSON object")

    # 3Ô∏è‚É£ Parse JSON safely
    data = json.loads(json_str)

    # 4Ô∏è‚É£ Validate required fields
    if not REQUIRED_KEYS.issubset(data.keys()):
        raise ValueError("Missing required keys in JSON response")

    # 5Ô∏è‚É£ Validate triage level
    if data.get("triage_level") not in VALID_TRIAGE:
        raise ValueError(f"Invalid triage level: {data.get('triage_level')}")

    # 6Ô∏è‚É£ Validate advice keys
    if not isinstance(data["home_advice"], list):
        raise ValueError("home_advice must be a list")

    data["home_advice"] = [
        key for key in data["home_advice"]
        if key in VALID_ADVICE
    ]

    return data

def classify(summary_text):
    prompt = f"""<start_of_turn>user
You are an expert pediatric triage assistant.
Analyze the following clinical observations for a child aged 6-12 and classify the triage level.

URGENCY LEVELS:
RED ‚Äì Emergency: Immediate hospital/ER required. Life-threatening or unstable symptoms.
YELLOW ‚Äì Urgent: Visit a doctor/clinic within 24 hours. Symptoms are worsening but currently stable.
GREEN ‚Äì Observation: Home care and monitoring. Minor symptoms.

INSTRUCTIONS:
1. Carefully review the "Clinical Observations" provided.
2. Provide your findings only in a valid JSON format.
3. Select the most relevant advice keys from the ADVICE_LIBRARY below (select 2-3 items).

ADVICE_LIBRARY:
- REST: Ensure the child gets adequate rest.
- FLUIDS: Encourage frequent intake of clean fluids.
- LIGHT_DIET: Provide light, easily digestible food.
- HYGIENE: Maintain proper hand hygiene.
- MONITOR_SYMPTOMS: Monitor symptoms closely for any worsening.
- TEMPERATURE_CHECK: Check temperature periodically if fever is present.

Return format:
{{
  "triage_level": "RED/YELLOW/GREEN",
  "reasoning": "A concise clinical explanation focusing on the severity and combination of symptoms provided.",
  "confidence": "High/Medium/Low",
  "home_advice": ["KEY1", "KEY2"]
}}

Clinical Observations:
{summary_text}<end_of_turn>
<start_of_turn>model
"""
    inputs = tokenizer(prompt, return_tensors="pt").to(model.device)
    with torch.no_grad():
        output = model.generate(
            **inputs,
            max_new_tokens=400,
            temperature=0.0,
            do_sample=False,
            pad_token_id=tokenizer.eos_token_id
        )

    generated_tokens = output[0][inputs["input_ids"].shape[-1]:]
    response = tokenizer.decode(generated_tokens, skip_special_tokens=True).strip()

    # Try robust JSON extraction
    try:
        res = extract_json_response(response)
        # Confidence auto-bump for RED
        if res.get("triage_level") == "RED":
            res["confidence"] = "High (Model + Structured Assessment)"
        return res
    except Exception as e:
        # Fallback if AI fails JSON
        return {
    "triage_level": "YELLOW",
    "reasoning": "AI could not confidently analyze the case. As a precaution, medical evaluation is recommended.",
    "confidence": "Low",
    "home_advice": []
        }

# -----------------------------
# LANGUAGE OUTPUT FORMATTERS
# -----------------------------
def malayalam_output(triage_level):
    if triage_level == "RED":
        return """üî¥ **‡¥Ö‡¥ü‡¥ø‡¥Ø‡¥®‡µç‡¥§‡¥∞ ‡¥ö‡¥ø‡¥ï‡¥ø‡¥§‡µç‡¥∏ ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥Æ‡¥æ‡¥£‡µç (Emergency)**
‡¥â‡¥ü‡µª ‡¥í‡¥∞‡µÅ ‡¥™‡µÄ‡¥°‡¥ø‡¥Ø‡¥æ‡¥ü‡µç‡¥∞‡¥ø‡¥ï‡µç ‡¥Ö‡¥§‡µç‡¥Ø‡¥æ‡¥π‡¥ø‡¥§ ‡¥µ‡¥ø‡¥≠‡¥æ‡¥ó‡¥§‡µç‡¥§‡¥ø‡µΩ (ER) ‡¥é‡¥§‡µç‡¥§‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.
‚ö†Ô∏è ‡¥∂‡µç‡¥µ‡¥æ‡¥∏‡¥Ç ‡¥Æ‡µÅ‡¥ü‡µç‡¥ü‡µΩ, ‡¥¨‡µã‡¥ß‡¥ï‡µç‡¥∑‡¥Ø‡¥Ç, ‡¥ï‡¥†‡¥ø‡¥®‡¥Æ‡¥æ‡¥Ø ‡¥∞‡¥ï‡µç‡¥§‡¥∏‡µç‡¥∞‡¥æ‡¥µ‡¥Ç ‡¥é‡¥®‡µç‡¥®‡¥ø‡¥µ ‡¥â‡¥£‡µç‡¥ü‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥í‡¥ü‡µç‡¥ü‡µÅ‡¥Ç ‡¥µ‡µà‡¥ï‡¥ø‡¥ï‡µç‡¥ï‡¥∞‡µÅ‡¥§‡µç."""
    elif triage_level == "YELLOW":
        return """üü° **‡¥°‡µã‡¥ï‡µç‡¥ü‡¥±‡µÜ ‡¥ï‡¥æ‡¥£‡µÅ‡¥ï (Urgent Care)**
‡¥Ö‡¥ü‡µÅ‡¥§‡µç‡¥§ 24 ‡¥Æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÇ‡¥±‡¥ø‡¥®‡µÅ‡¥≥‡µç‡¥≥‡¥ø‡µΩ ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥°‡µã‡¥ï‡µç‡¥ü‡¥±‡µÜ‡¥Ø‡µã ‡¥Ö‡¥ü‡µÅ‡¥§‡µç‡¥§‡µÅ‡¥≥‡µç‡¥≥ ‡¥ï‡µç‡¥≤‡¥ø‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µã ‡¥∏‡¥®‡µç‡¥¶‡µº‡¥∂‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.
‚ö†Ô∏è ‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ ‡¥ï‡µÇ‡¥ü‡µÅ‡¥ï‡¥Ø‡¥æ‡¥£‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥â‡¥ü‡µª ‡¥Ü‡¥∂‡µÅ‡¥™‡¥§‡µç‡¥∞‡¥ø‡¥Ø‡¥ø‡µΩ ‡¥™‡µã‡¥ï‡µÅ‡¥ï."""
    elif triage_level == "GREEN":
        return """üü¢ **‡¥µ‡µÄ‡¥ü‡µç‡¥ü‡¥ø‡µΩ ‡¥µ‡¥ø‡¥∂‡µç‡¥∞‡¥Æ‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ç (Home Care)**
‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡µΩ ‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ ‡¥ó‡µÅ‡¥∞‡µÅ‡¥§‡¥∞‡¥Æ‡¥≤‡µç‡¥≤. ‡¥§‡¥æ‡¥¥‡µÜ ‡¥®‡µΩ‡¥ï‡¥ø‡¥Ø‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥® ‡¥®‡¥ø‡µº‡¥¶‡µç‡¥¶‡µá‡¥∂‡¥ô‡µç‡¥ô‡µæ ‡¥™‡¥æ‡¥≤‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.
‚ö†Ô∏è ‡¥™‡¥®‡¥ø ‡¥ï‡µÇ‡¥ü‡µÅ‡¥ï‡¥Ø‡µã ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥Ö‡¥µ‡¥∂‡¥®‡¥æ‡¥ï‡µÅ‡¥ï‡¥Ø‡µã ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥æ‡µΩ ‡¥°‡µã‡¥ï‡µç‡¥ü‡¥±‡µÜ ‡¥∏‡¥Æ‡µÄ‡¥™‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."""
    else:
        return """‚ö†Ô∏è **‡¥∏‡¥æ‡¥ô‡µç‡¥ï‡µá‡¥§‡¥ø‡¥ï ‡¥§‡¥ï‡¥∞‡¥æ‡µº (System Error)**
‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥µ‡¥ø‡¥∂‡¥ï‡¥≤‡¥®‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡µª ‡¥á‡¥™‡µç‡¥™‡µã‡µæ ‡¥∏‡¥æ‡¥ß‡µç‡¥Ø‡¥Æ‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥ø‡¥≤‡µç‡¥≤. ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥∏‡µç‡¥µ‡¥æ‡¥∏‡µç‡¥•‡µç‡¥Ø‡¥Æ‡µÅ‡¥£‡µç‡¥ü‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥¶‡¥Ø‡¥µ‡¥æ‡¥Ø‡¥ø ‡¥í‡¥∞‡µÅ ‡¥°‡µã‡¥ï‡µç‡¥ü‡¥±‡µÜ ‡¥∏‡¥Æ‡µÄ‡¥™‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."""

def english_output(triage_level):
    if triage_level == "RED":
        return """üî¥ **Emergency Care Required**
Take the child to the Pediatric Emergency Room (ER) immediately.
‚ö†Ô∏è Do not delay if there is breathing difficulty, loss of consciousness, or heavy bleeding."""
    elif triage_level == "YELLOW":
        return """üü° **Urgent Care**
Visit your pediatrician or an urgent care clinic within the next 24 hours.
‚ö†Ô∏è seek immediate care if symptoms worsen."""
    elif triage_level == "GREEN":
        return """üü¢ **Home Care & Observation**
Symptoms are currently stable. Follow the home care instructions below.
‚ö†Ô∏è Contact a doctor if fever increases or the child becomes very weak."""
    else:
        return """‚ö†Ô∏è **System Error**
We are unable to process the assessment at this time. Please consult a doctor if you are concerned."""

# -----------------------------
# TERMINAL UI HELPERS
# -----------------------------
def get_terminal_input(prompt, input_type="text", options=None, format_func=None):
    while True:
        if options:
            print(f"\n{prompt}")
            for i, opt in enumerate(options):
                label = format_func(opt) if format_func else opt
                print(f"  {i+1}. {label}")
            val = input("Select option (number): ").strip()
            if val.isdigit() and 1 <= int(val) <= len(options):
                return options[int(val)-1]
            print("Invalid selection. Please try again.")
        else:
            val = input(f"\n{prompt}: ").strip()
            if input_type == "number":
                if val.isdigit():
                    return int(val)
                print("Invalid number. Please try again.")
            else:
                return val

def main():
    print("\n" + "="*50)
    print("üè• Pediatric Triage System (Age 6‚Äì12)")
    print("="*50)

    # 1. Language Selection
    lang_choice = get_terminal_input(
        "Select Language / ‡¥≠‡¥æ‡¥∑ ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï:",
        options=["English", "Malayalam"]
    )
    l_key = "en" if lang_choice == "English" else "ml"

    answers = {}

    # 2. General Questions
    print("\n--- General Questions / ‡¥™‡µä‡¥§‡µÅ‡¥µ‡¥æ‡¥Ø ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡µæ ---")
    q1 = QUESTIONS["General"]["Q1"]
    while True:
        age = get_terminal_input(q1[l_key], input_type="number")
        if q1["min"] <= age <= q1["max"]:
            answers["Q1"] = age
            break
        print(f"Age must be between {q1['min']} and {q1['max']}.")

    for q_id in ["Q2", "Q3", "Q4", "Q5"]:
        q_data = QUESTIONS["General"][q_id]
        opts = list(q_data["options"].keys())
        answers[q_id] = get_terminal_input(
            q_data[l_key],
            options=opts,
            format_func=lambda x: q_data["options"][x][l_key]
        )
        if q_id == "Q3" and answers[q_id] == "Yes":
            print("‚ö†Ô∏è WARNING: High risk flag.")

    # 3. Category Selection
    categories = ["Cold / Cough / Fever", "Stomach Pain / Diarrhea / Vomiting", "Breathing Problem", "Body Pain / Headache"]
    print("\n--- Symptom Categories / ‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ ---")
    print("Choose symptoms (comma separated numbers, e.g., 1,3 or press Enter if none):")
    for i, cat in enumerate(categories):
        print(f"  {i+1}. {cat}")

    cat_input = input("Selection: ").strip()
    selected_cats = []
    if cat_input:
        indices = [i.strip() for i in cat_input.split(",")]
        for idx in indices:
            if idx.isdigit() and 1 <= int(idx) <= len(categories):
                selected_cats.append(categories[int(idx)-1])

    # 4. Dynamic Category Questions
    for cat in selected_cats:
        print(f"\n--- {cat} ---")
        for q_id, q_data in QUESTIONS[cat].items():
            opts = list(q_data["options"].keys())
            answers[q_id] = get_terminal_input(
                q_data[l_key],
                options=opts,
                format_func=lambda x: q_data["options"][x][l_key]
            )
            if q_data.get("is_critical") and answers[q_id] == "Yes":
                print("‚ö†Ô∏è WARNING: High risk flag.")

    # 5. Critical Questions
    print("\n--- Critical Conditions / ‡¥ó‡µÅ‡¥∞‡µÅ‡¥§‡¥∞‡¥Æ‡¥æ‡¥Ø ‡¥Ö‡¥µ‡¥∏‡µç‡¥•‡¥ï‡µæ ---")
    for q_id, q_data in QUESTIONS["Critical Red-Flags"].items():
        opts = list(q_data["options"].keys())
        answers[q_id] = get_terminal_input(
            q_data[l_key],
            options=opts,
            format_func=lambda x: q_data["options"][x][l_key]
        )
        if answers[q_id] == "Yes":
            print("‚ö†Ô∏è CRITICAL: RED Flag / ‡¥ó‡µÅ‡¥∞‡µÅ‡¥§‡¥∞‡¥Æ‡¥æ‡¥Ø ‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥Æ‡¥æ‡¥£‡µç.")

    # 6. Result Calculation
    print("\n" + "="*50)
    print("Analyzing Urgency...")

    # Rule-based check
    red_flag_data = check_red_flags(answers)

    if red_flag_data:
        res_json = red_flag_data
    else:
        # AI-based check
        summary = build_summary(answers)
        res_json = classify(summary)

    # Display Triage Advice
    if l_key == "ml":
        advice_msg = malayalam_output(res_json["triage_level"])
    else:
        advice_msg = english_output(res_json["triage_level"])

    print("\n" + advice_msg)

    # Show Home Care Advice
    if res_json.get("home_advice") and res_json["triage_level"] != "RED":
        print("\n--- Home Care Advice / ‡¥µ‡µÄ‡¥ü‡µç‡¥ü‡µÅ‡¥ö‡¥ø‡¥ï‡¥ø‡¥§‡µç‡¥∏‡¥æ ‡¥®‡¥ø‡µº‡¥¶‡µç‡¥¶‡µá‡¥∂‡¥ô‡µç‡¥ô‡µæ ---")
        for key in res_json["home_advice"]:
            advice_item = HOME_ADVICE_LIBRARY.get(key)
            if advice_item:
                print(f"- {advice_item[l_key]}")

    # Show Reasoning
    print("\n" + "-"*30)
    print(f"Reasoning: {res_json['reasoning']}")
    print(f"Confidence: {res_json['confidence']}")
    print("-"*30)

    print("\nDisclaimer: This tool is for informational purposes only and is not a substitute for professional medical advice, diagnosis, or treatment.")
    print("="*50 + "\n")

if __name__ == "__main__":
    main()

from transformers import AutoTokenizer

tokenizer = AutoTokenizer.from_pretrained("google/medgemma-4b-it")
print("Tokenizer loaded")

from transformers import AutoTokenizer, AutoModelForCausalLM
import torch

model_id = "google/medgemma-4b-it"

# Ensure tokenizer is also loaded if not already available in the current scope
# (though it might be from a previous cell)
# tokenizer = AutoTokenizer.from_pretrained(model_id)

model = AutoModelForCausalLM.from_pretrained(
    model_id,
    device_map="auto" # Change device_map to 'auto' to use GPU if available
)

print("Model loaded on GPU/CPU (auto-detected)")



import json

tokenizer = AutoTokenizer.from_pretrained("google/medgemma-4b-it")



REQUIRED_KEYS = {"triage_level", "reasoning", "confidence", "home_advice"}

VALID_ADVICE = {
    "REST",
    "FLUIDS",
    "LIGHT_DIET",
    "HYGIENE",
    "MONITOR_SYMPTOMS",
    "TEMPERATURE_CHECK"
}

def extract_json_response(response_text: str):
    """
    Safely extract first valid JSON object from model output.
    """

    # 1Ô∏è‚É£ Remove markdown wrappers if present
    cleaned = response_text.strip()
    cleaned = cleaned.replace("```json", "").replace("```", "").strip()

    # 2Ô∏è‚É£ Find first balanced JSON block
    start = cleaned.find("{")
    if start == -1:
        raise ValueError("No JSON object found")

    brace_count = 0
    for i in range(start, len(cleaned)):
        if cleaned[i] == "{":
            brace_count += 1
        elif cleaned[i] == "}":
            brace_count -= 1

        if brace_count == 0:
            json_str = cleaned[start:i+1]
            break
    else:
        raise ValueError("Incomplete JSON object")

    # 3Ô∏è‚É£ Parse JSON safely
    data = json.loads(json_str)

    # 4Ô∏è‚É£ Validate required fields
    if not REQUIRED_KEYS.issubset(data.keys()):
        raise ValueError("Missing required keys in JSON response")

    # 5Ô∏è‚É£ Validate advice keys
    if not isinstance(data["home_advice"], list):
        raise ValueError("home_advice must be a list")

    data["home_advice"] = [
        key for key in data["home_advice"]
        if key in VALID_ADVICE
    ]

    return data

def classify(summary_text):
    prompt = f"""<start_of_turn>user
You are an expert pediatric triage assistant.
Analyze the following clinical observations for a child aged 6-12 and classify the triage level.

URGENCY LEVELS:
RED ‚Äì Emergency: Immediate hospital/ER required. Life-threatening or unstable symptoms.
YELLOW ‚Äì Urgent: Visit a doctor/clinic within 24 hours. Symptoms are worsening but currently stable.
GREEN ‚Äì Observation: Home care and monitoring. Minor symptoms.

INSTRUCTIONS:
1. Carefully review the "Clinical Observations" provided.
2. Provide your findings only in a valid JSON format.
3. Select the most relevant advice keys from the ADVICE_LIBRARY below (select 2-3 items).

ADVICE_LIBRARY:
- REST: Ensure the child gets adequate rest.
- FLUIDS: Encourage frequent intake of clean fluids.
- LIGHT_DIET: Provide light, easily digestible food.
- HYGIENE: Maintain proper hand hygiene.
- MONITOR_SYMPTOMS: Monitor symptoms closely for any worsening.
- TEMPERATURE_CHECK: Check temperature periodically if fever is present.

Return format:
{{
  "triage_level": "RED/YELLOW/GREEN",
  "reasoning": "A concise clinical explanation focusing on the severity and combination of symptoms provided.",
  "confidence": "High/Medium/Low",
  "home_advice": ["KEY1", "KEY2"]
}}

Clinical Observations:
{summary_text}<end_of_turn>
<start_of_turn>model
"""
    inputs = tokenizer(prompt, return_tensors="pt").to(model.device)
    with torch.no_grad():


      output = model.generate(
    **inputs,
    max_new_tokens=200,
    temperature=0.1,
    do_sample=True,
    top_p=0.9,
    pad_token_id=tokenizer.eos_token_id
    )
    generated_tokens = output[0][inputs["input_ids"].shape[-1]:]
    response = tokenizer.decode(
        generated_tokens,
        skip_special_tokens=True
    ).strip()

    print(response)


    # Simple JSON extraction in case model adds text before/after
    try:
        return extract_json_response(response)
    except:
        # Fallback if AI fails JSON
        return {
            "triage_level": "ERROR",
            "reasoning": f"Failed to parse AI response. Raw output: {response}",
            "confidence": "None"
        }

summary_text = "The child is 6 years old. Moderate fever."

ans = classify(summary_text)
print("ans:",ans)



model

import torch

tokenizer = AutoTokenizer.from_pretrained("google/medgemma-4b-it")

def chat(question, max_new_tokens=500):
    prompt = f"""You are a pediatric triage assistant for parents in rural India.

Rules you MUST follow:
- You do NOT diagnose diseases.
- You do NOT prescribe medicines or dosages.
- You help decide: home care vs clinic visit vs urgent care.
- You always consider the child's AGE.
- You give simple, practical advice using safe home measures.
- You clearly say WHEN to see a doctor.
- If danger signs are present, you say "seek medical care urgently".

Answer format:
1. What this could generally mean (non-diagnostic)
2. What can be done at home now
3. Warning signs ‚Äì when to see a doctor
4. One short reassurance line
5. Do not repeat question
---------
Question:
{question}
---------
Answer:"""

    inputs = tokenizer(prompt, return_tensors="pt").to(model.device)
    with torch.no_grad():
        outputs = model.generate(
            **inputs,
            max_new_tokens=max_new_tokens,
            temperature=0.1,
            do_sample=False,
            eos_token_id=tokenizer.eos_token_id,
        )

    return tokenizer.decode(outputs[0], skip_special_tokens=True)



import torch

tokenizer = AutoTokenizer.from_pretrained("google/medgemma-4b-it")

def generate_explanation(data: dict, triage_result: str):
    prompt = f"""
You are a pediatric triage assistant.

STRICT RULES:
- Do NOT diagnose diseases.
- Do NOT prescribe medicines.
- Do NOT give dosages.
- The triage decision is already made: {triage_result}
- You cannot change it.
- Only explain what parents should do next.

Child Data:
{data}

Output format:

1. What this generally means (non-diagnostic)
2. What can be done now at home (safe measures only)
3. Clear instruction based on triage:
   - GREEN ‚Üí home care
   - YELLOW ‚Üí visit clinic within 24‚Äì48 hours
   - RED ‚Üí seek medical care urgently
4. One short reassurance line
"""

    inputs = tokenizer(prompt, return_tensors="pt").to(model.device)
    with torch.no_grad():
        outputs = model.generate(
            **inputs,
            max_new_tokens=500,
            temperature=0.1,
            do_sample=False,
            eos_token_id=tokenizer.eos_token_id,
        )

    return tokenizer.decode(outputs[0], skip_special_tokens=True)

question = """
My 2-year-old child has fever since yesterday.
He is eating less but still playing.
No vomiting or breathing problem.
What should I do?
"""
answer = chat(question)
print(answer)



"""#V1

"""



"""
Clinical Scope ‚Äì LOCKED MVP
Age: 0‚Äì12 years
Outputs: GREEN / YELLOW / RED
No diagnosis. No medicines. No dosage.
"""

GREEN = "GREEN"
YELLOW = "YELLOW"
RED = "RED"

SUPPORTED_SYMPTOMS = [
    "fever",
    "cough_breathing",
    "vomiting_diarrhea",
    "rash_with_fever",
    "poor_feeding_lethargy"
]

DANGER_SIGNS = [
    "difficulty_breathing",
    "chest_indrawing",
    "seizures",
    "unconscious",
    "not_drinking",
    "persistent_vomiting",
    "bluish_lips",
    "stiff_neck",
]

def validate_age(age_years: float):
    if not (0 <= age_years <= 12):
        raise ValueError("Age must be between 0 and 12 years.")

def check_danger_conditions(data: dict):
    validate_age(data["age_years"])

    age_months = data["age_years"] * 12

    # Neonatal fever rule
    if age_months < 2 and data.get("fever", False):
        return RED

    # Hard danger signs
    for sign in DANGER_SIGNS:
        if data.get(sign, False):
            return RED

    return None

def triage_child(data: dict):
    """
    Returns: GREEN / YELLOW / RED
    """

    # Step 1 ‚Äì Hard stop danger check
    danger = check_danger_conditions(data)
    if danger == RED:
        return RED

    # Step 2 ‚Äì Symptom-based triage
    age = data["age_years"]

    # Fever logic
    if data.get("fever"):
        if data.get("fever_days", 0) >= 3:
            return YELLOW
        else:
            return GREEN

    # Cough logic
    if data.get("cough"):
        if data.get("fast_breathing", False):
            return YELLOW
        return GREEN

    # Vomiting / diarrhea
    if data.get("vomiting") or data.get("diarrhea"):
        if data.get("dehydration_signs", False):
            return YELLOW
        return GREEN

    # Rash + fever
    if data.get("rash") and data.get("fever"):
        return YELLOW

    # Poor feeding / lethargy
    if data.get("poor_feeding"):
        return YELLOW

    return GREEN

"""#V2"""

import torch

tokenizer = AutoTokenizer.from_pretrained("google/medgemma-4b-it")

def generate_explanation(data: dict, triage_result: str):
    prompt = f"""
You are a pediatric triage assistant.

STRICT RULES:
- Do NOT diagnose diseases.
- Do NOT prescribe medicines.
- Do NOT give dosages.
- The triage decision is already made: {triage_result}
- You cannot change it.
- Only explain what parents should do next.

Child Data:
{data}

Output format:

1. What this generally means (non-diagnostic)
2. What can be done now at home (safe measures only)
3. Clear instruction based on triage:
   - GREEN ‚Üí home care
   - YELLOW ‚Üí visit clinic within 24‚Äì48 hours
   - RED ‚Üí seek medical care urgently
4. One short reassurance line
"""

    inputs = tokenizer(prompt, return_tensors="pt").to(model.device)
    with torch.no_grad():
        outputs = model.generate(
            **inputs,
            max_new_tokens=500,
            temperature=0.1,
            do_sample=False,
            eos_token_id=tokenizer.eos_token_id,
        )

    return tokenizer.decode(outputs[0], skip_special_tokens=True)

import torch

tokenizer = AutoTokenizer.from_pretrained("google/medgemma-4b-it")



import torch

tokenizer = AutoTokenizer.from_pretrained("google/medgemma-4b-it")


def generate_explanation(data: dict, triage_result: str):
    prompt = f"""
You are a pediatric triage assistant.

STRICT RULES:
- Do NOT diagnose diseases.
- Do NOT prescribe medicines.
- Do NOT give dosages.
- The triage decision is already made: {triage_result}
- You cannot change it.
- Only explain what parents should do next.

Child Data:
{data}

Output format:

1. What this generally means (non-diagnostic)
2. What can be done now at home (safe measures only)
3. Clear instruction based on triage:
   - GREEN ‚Üí home care
   - YELLOW ‚Üí visit clinic within 24‚Äì48 hours
   - RED ‚Üí seek medical care urgently
4. One short reassurance line
"""

    inputs = tokenizer(prompt, return_tensors="pt").to(model.device)
    with torch.no_grad():
        outputs = model.generate(
            **inputs,
            max_new_tokens=500,
            temperature=0.1,
            do_sample=False,
            eos_token_id=tokenizer.eos_token_id,
        )

    return tokenizer.decode(outputs[0], skip_special_tokens=True)



def generate_explanation2(data: dict):
    prompt = f"""
You are a pediatric triage assistant.

You evaluate children aged 0‚Äì12 years.

IMPORTANT RULES:
- Do NOT diagnose diseases.
- Do NOT mention disease names.
- Do NOT prescribe medicines.
- Do NOT give dosage advice.
- Do NOT recommend specific drugs.
- Only assess urgency level.
- Base decision ONLY on provided data.
- If any danger sign is present, output URGENT.

Triage Levels:
- GREEN  ‚Üí Home Care
- YELLOW ‚Üí Clinic Visit (within 24‚Äì48 hours)
- RED    ‚Üí Urgent Care immediately

Child Data:
{data}

You MUST respond ONLY in valid JSON.
No extra text.
No explanation outside JSON.
No markdown.
No commentary.

JSON FORMAT:

{{
  "triage_level": "GREEN or YELLOW or RED",
  "reasoning_summary": "Short non-diagnostic explanation of why this level was chosen.",
  "recommended_action": "Clear instruction based on triage level.",
  "home_care_advice": [
    "Safe supportive measure 1",
    "Safe supportive measure 2"
  ],
  "warning_signs_to_watch": [
    "Sign 1",
    "Sign 2"
  ],
  "reassurance_message": "One short calm reassurance sentence."
}}

Return ONLY JSON.
"""

    inputs = tokenizer(prompt, return_tensors="pt").to(model.device)
    with torch.no_grad():
        outputs = model.generate(
            **inputs,
            max_new_tokens=500,
            temperature=0.1,
            do_sample=False,
            eos_token_id=tokenizer.eos_token_id,
        )

    return tokenizer.decode(outputs[0], skip_special_tokens=True)

def collect_input():

    print("Enter child information:\n")

    age = float(input("Age (years): "))
    fever = input("Fever? (y/n): ") == "y"
    fever_days = int(input("Fever for how many days? ")) if fever else 0

    cough = input("Cough? (y/n): ") == "y"
    fast_breathing = input("Fast breathing? (y/n): ") == "y"

    vomiting = input("Vomiting? (y/n): ") == "y"
    diarrhea = input("Diarrhea? (y/n): ") == "y"

    rash = input("Rash? (y/n): ") == "y"
    poor_feeding = input("Poor feeding? (y/n): ") == "y"

    difficulty_breathing = input("Difficulty breathing? (y/n): ") == "y"
    chest_indrawing = input("Chest indrawing? (y/n): ") == "y"
    seizures = input("Seizures? (y/n): ") == "y"
    unconscious = input("Unconscious? (y/n): ") == "y"
    not_drinking = input("Not drinking at all? (y/n): ") == "y"
    persistent_vomiting = input("Persistent vomiting? (y/n): ") == "y"
    bluish_lips = input("Bluish lips? (y/n): ") == "y"
    stiff_neck = input("Stiff neck? (y/n): ") == "y"

    return {
        "age_years": age,
        "fever": fever,
        "fever_days": fever_days,
        "cough": cough,
        "fast_breathing": fast_breathing,
        "vomiting": vomiting,
        "diarrhea": diarrhea,
        "rash": rash,
        "poor_feeding": poor_feeding,
        "difficulty_breathing": difficulty_breathing,
        "chest_indrawing": chest_indrawing,
        "seizures": seizures,
        "unconscious": unconscious,
        "not_drinking": not_drinking,
        "persistent_vomiting": persistent_vomiting,
        "bluish_lips": bluish_lips,
        "stiff_neck": stiff_neck,
    }


def main():

    data = collect_input()

    triage = triage_child(data)

    print("\nTriage Decision:")
    if triage == GREEN:
        print("üü¢ HOME CARE")
    elif triage == YELLOW:
        print("üü° CLINIC VISIT")
    else:
        print("üî¥ URGENT CARE")

    print("\nGenerating explanation...\n")
    explanation = generate_explanation2(data)
    print(explanation)


if __name__ == "__main__":
    main()



import torch
import json
import re
from transformers import AutoTokenizer, AutoModelForCausalLM

MODEL_NAME = "google/medgemma-4b-it"

tokenizer = AutoTokenizer.from_pretrained(MODEL_NAME)
model = AutoModelForCausalLM.from_pretrained(
    MODEL_NAME,
    torch_dtype=torch.float32,
    device_map="cpu"
)

VALID_CATEGORIES = {"URGENT", "PRIORITY_VISIT", "HOME_CARE"}
VALID_CONFIDENCE = {"LOW", "HIGH"}

def extract_json(text):
    try:
        match = re.search(r"\{.*\}", text, re.DOTALL)
        if match:
            return json.loads(match.group())
        return None
    except:
        return None


def safety_override(patient_dict, predicted_category):
    """
    Hard emergency rules.
    """
    red_flags = [
        "difficulty_breathing",
        "chest_indrawing",
        "seizure",
        "bleeding",
        "unconscious",
        "no_urine"
    ]

    for flag in red_flags:
        if patient_dict.get(flag) is True:
            return "URGENT"

    return predicted_category


def generate_triage_response(patient_dict):

    patient_json = json.dumps(patient_dict)

    prompt = f"""
You are a pediatric clinical triage classifier.

Return ONLY valid JSON in this format:

{{
  "category": "URGENT | PRIORITY_VISIT | HOME_CARE",
  "confidence_level": "LOW | HIGH",
  "home_care_advice": "string",
  "warning_signs_to_watch": "string",
  "concise_reasoning": "string"
}}

Do NOT add explanations outside JSON.

Patient Data:
{patient_json}
"""

    inputs = tokenizer(prompt, return_tensors="pt").to(model.device)

    outputs = model.generate(
        **inputs,
        max_new_tokens=200,
        temperature=0.0,
        do_sample=False,
        eos_token_id=tokenizer.eos_token_id
    )

    response = tokenizer.decode(outputs[0], skip_special_tokens=True)

    parsed = extract_json(response)

    if parsed is None:
        return {
            "category": "PRIORITY_VISIT",
            "confidence_level": "LOW",
            "home_care_advice": "",
            "warning_signs_to_watch": "",
            "concise_reasoning": "Model output parsing failed."
        }

    # Validate category
    if parsed.get("category") not in VALID_CATEGORIES:
        parsed["category"] = "PRIORITY_VISIT"

    if parsed.get("confidence_level") not in VALID_CONFIDENCE:
        parsed["confidence_level"] = "LOW"

    # Apply safety override
    final_category = safety_override(patient_dict, parsed["category"])
    parsed["category"] = final_category

    return parsed

"""```json
{
  "triage_level": "YELLOW",
  "reasoning_summary": "Fever and cough for 2 days warrant a clinic visit to rule out other causes.",
  "recommended_action": "Schedule a clinic visit within 24-48 hours.",
  "home_care_advice": [
    "Ensure adequate hydration.",
    "Rest."
  ],
  "warning_signs_to_watch": [
    "Difficulty breathing",
    "Bluish lips"
  ],
  "reassurance_message": "It's important to get this checked out to ensure it's not something more serious."
}
```
"""

import streamlit as st
import torch
import json
import re
from transformers import AutoTokenizer, AutoModelForCausalLM

# -----------------------------
# CONFIG
# -----------------------------
MODEL_NAME = "google/medgemma-4b-it"
device = "cuda" if torch.cuda.is_available() else "cpu"

@st.cache_resource
def load_model():
    tokenizer = AutoTokenizer.from_pretrained(MODEL_NAME)
    model = AutoModelForCausalLM.from_pretrained(
        MODEL_NAME,
        torch_dtype=torch.float16 if device == "cuda" else torch.float32,
        device_map="auto"
    )
    return tokenizer, model

tokenizer, model = load_model()

# -----------------------------
# QUESTION DATA STRUCTURE
# -----------------------------
QUESTIONS = {
    "General": {
        "Q1": {
            "en": "What is the child‚Äôs age?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥µ‡¥Ø‡¥∏‡µç ‡¥é‡¥§‡µç‡¥∞‡¥Ø‡¥æ‡¥£‡µç?",
            "type": "number", "min": 6, "max": 12,
            "context": lambda v: f"The child is {v} years old."
        },
        "Q2": {
            "en": "How long has the problem been present?",
            "ml": "‡¥à ‡¥™‡µç‡¥∞‡¥∂‡µç‡¥®‡¥Ç ‡¥é‡¥§‡µç‡¥∞ ‡¥¶‡¥ø‡¥µ‡¥∏‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥§‡µÅ‡¥ü‡¥∞‡µÅ‡¥®‡µç‡¥®‡µÅ?",
            "type": "radio",
            "options": {
                "< 1 day": {"en": "< 1 day", "ml": "1 ‡¥¶‡¥ø‡¥µ‡¥∏‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥§‡¥æ‡¥¥‡µÜ"},
                "1‚Äì2 days": {"en": "1‚Äì2 days", "ml": "1-2 ‡¥¶‡¥ø‡¥µ‡¥∏‡¥Ç"},
                "3+ days": {"en": "3+ days", "ml": "3 ‡¥¶‡¥ø‡¥µ‡¥∏‡¥§‡µç‡¥§‡¥ø‡¥≤‡¥ß‡¥ø‡¥ï‡¥Ç"}
            },
            "context": {
                "< 1 day": "The symptoms started recently (less than 24 hours ago).",
                "1‚Äì2 days": "The symptoms have been present for 1 to 2 days.",
                "3+ days": "The symptoms have persisted for more than 3 days."
            }
        },
        "Q3": {
            "en": "Is the child unusually drowsy, confused, or not responding normally?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥Ö‡¥∏‡¥æ‡¥ß‡¥æ‡¥∞‡¥£‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥â‡¥±‡¥ï‡µç‡¥ï‡¥Æ‡µÅ‡¥≥‡µç‡¥≥‡¥§‡µã ‡¥™‡µç‡¥∞‡¥§‡¥ø‡¥ï‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥§‡µç‡¥§‡¥§‡µã ‡¥Ü‡¥£‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child is showing signs of altered consciousness, unusual drowsiness, or confusion.",
                "No": "The child is alert and responding normally to surroundings."
            }
        },
        "Q4": {
            "en": "Is the child able to drink and keep fluids down?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥µ‡µÜ‡¥≥‡µç‡¥≥‡¥Ç ‡¥ï‡µÅ‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥®‡µÅ‡¥Ç ‡¥®‡¥ø‡¥≤‡¥®‡¥ø‡µº‡¥§‡µç‡¥§‡¥æ‡¥®‡µÅ‡¥Ç ‡¥ï‡¥¥‡¥ø‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is able to tolerate oral fluids and maintain hydration.",
                "No": "The child is unable to drink or keep any fluids down, risking dehydration."
            }
        },
        "Q5": {
            "en": "Does the child have asthma, diabetes, heart disease, or other chronic illness?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥Ü‡¥∏‡µç‡¥§‡µç‡¥Æ, ‡¥™‡µç‡¥∞‡¥Æ‡µá‡¥π‡¥Ç, ‡¥π‡µÉ‡¥¶‡µç‡¥∞‡µã‡¥ó‡¥Ç ‡¥§‡µÅ‡¥ü‡¥ô‡µç‡¥ô‡¥ø‡¥Ø ‡¥¶‡µÄ‡µº‡¥ò‡¥ï‡¥æ‡¥≤ ‡¥∞‡µã‡¥ó‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child has a pre-existing chronic medical condition (e.g., asthma, diabetes).",
                "No": "The child has no known chronic underlying illnesses."
            }
        },
    },
    "Cold / Cough / Fever": {

        "Q6": {
            "en": "How does the fever feel?",
            "ml": "‡¥™‡¥®‡¥ø ‡¥é‡¥ô‡µç‡¥ô‡¥®‡µÜ ‡¥§‡µã‡¥®‡µç‡¥®‡µÅ‡¥®‡µç‡¥®‡µÅ?",
            "type": "radio",
            "options": {
                "Warm but child active": {"en": "Warm but child active", "ml": "‡¥ö‡µÜ‡¥±‡¥ø‡¥Ø ‡¥™‡¥®‡¥ø, ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥â‡¥®‡µç‡¥Æ‡µá‡¥∑‡¥µ‡¥æ‡¥®‡¥æ‡¥£‡µç"},
                "Hot and uncomfortable": {"en": "Hot and uncomfortable", "ml": "‡¥∂‡¥∞‡µÄ‡¥∞‡¥Ç ‡¥®‡¥®‡µç‡¥®‡¥æ‡¥Ø‡¥ø ‡¥ö‡µÇ‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µç, ‡¥Ü‡¥∏‡µç‡¥µ‡¥∏‡µç‡¥•‡¥§‡¥Ø‡µÅ‡¥£‡µç‡¥ü‡µç"},
                "Very hot and child weak": {"en": "Very hot and child weak", "ml": "‡¥ï‡¥†‡¥ø‡¥®‡¥Æ‡¥æ‡¥Ø ‡¥™‡¥®‡¥ø, ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥µ‡¥≥‡¥∞‡µÜ ‡¥Ö‡¥µ‡¥∂‡¥®‡¥æ‡¥£‡µç"}
            },
            "context": {
                "Warm but child active": "Mild fever with normal activity.",
                "Hot and uncomfortable": "Moderate fever.",
                "Very hot and child weak": "High fever affecting the child."
            }
        },
        "Q7": {
            "en": "Has the fever lasted more than 3 days?",
            "ml": "‡¥™‡¥®‡¥ø 3 ‡¥¶‡¥ø‡¥µ‡¥∏‡¥§‡µç‡¥§‡¥ø‡¥≤‡¥ß‡¥ø‡¥ï‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥§‡µÅ‡¥ü‡¥∞‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The fever has been prolonged, lasting more than 72 hours.",
                "No": "The fever is recent and has lasted less than 3 days."
            }
        },
        "Q8": {
            "en": "Is there a rash on the body?",
            "ml": "‡¥∂‡¥∞‡µÄ‡¥∞‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥ö‡µä‡¥±‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥≤‡µã ‡¥ö‡µº‡¥Æ‡µç‡¥Æ‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥™‡¥æ‡¥ü‡µÅ‡¥ï‡¥≥‡µã ‡¥â‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "A new skin rash or spots have appeared on the child's body.",
                "No": "There is no visible rash on the skin."
            }
        },
        "Q9": {
            "en": "Is the child unable to bend the neck forward?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥ï‡¥¥‡µÅ‡¥§‡µç‡¥§‡µç ‡¥Æ‡µÅ‡¥®‡µç‡¥®‡µã‡¥ü‡µç‡¥ü‡µç ‡¥ï‡µÅ‡¥®‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥®‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥ø‡¥≤‡µç‡¥≤‡µá?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child is experiencing neck stiffness (meningismus), unable to touch chin to chest.",
                "No": "The child has normal neck mobility."
            }
        },
    },
    "Stomach Pain / Diarrhea / Vomiting": {
        "Q10": {
            "en": "How many times has the child vomited in the last 24 hours?",
            "ml": "‡¥ï‡¥¥‡¥ø‡¥û‡µç‡¥û 24 ‡¥Æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÇ‡¥±‡¥ø‡µΩ ‡¥é‡¥§‡µç‡¥∞ ‡¥§‡¥µ‡¥£ ‡¥õ‡µº‡¥¶‡µç‡¥¶‡¥ø‡¥ö‡µç‡¥ö‡µÅ?",
            "type": "radio",
            "options": {
                "None": {"en": "None", "ml": "‡¥í‡¥®‡µç‡¥®‡µÅ‡¥Æ‡¥ø‡¥≤‡µç‡¥≤"},
                "1-3": {"en": "1-3", "ml": "1-3 ‡¥§‡¥µ‡¥£"},
                "4+": {"en": "4+", "ml": "4 ‡¥§‡¥µ‡¥£‡¥Ø‡¥ø‡µΩ ‡¥ï‡µÇ‡¥ü‡µÅ‡¥§‡µΩ"}
            },
            "context": {
                "None": "The child has not vomited in the last 24 hours.",
                "1-3": "The child has vomited 1 to 3 times recently.",
                "4+": "The child is experiencing frequent/excessive vomiting (4 or more times)."
            }
        },
        "Q11": {
            "en": "Is there blood in vomit or stool?",
            "ml": "‡¥õ‡µº‡¥¶‡µç‡¥¶‡¥ø‡¥Ø‡¥ø‡¥≤‡µã ‡¥Æ‡¥≤‡¥§‡µç‡¥§‡¥ø‡¥≤‡µã ‡¥∞‡¥ï‡µç‡¥§‡¥Ç ‡¥â‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "Visible blood is present in the child's vomit or bowel movements.",
                "No": "There is no blood observed in vomit or stool."
            }
        },
        "Q12": {
            "en": "Is the stomach pain severe and constant?",
            "ml": "‡¥µ‡¥Ø‡¥±‡µÅ‡¥µ‡µá‡¥¶‡¥® ‡¥ï‡¥†‡¥ø‡¥®‡¥µ‡µÅ‡¥Ç ‡¥∏‡µç‡¥•‡¥ø‡¥∞‡¥µ‡µÅ‡¥Æ‡¥æ‡¥£‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is reporting intense, continuous abdominal pain.",
                "No": "Abdominal pain is absent or only mild/intermittent."
            }
        },
        "Q13": {
            "en": "Has the child passed urine in the last 8 hours?",
            "ml": "‡¥ï‡¥¥‡¥ø‡¥û‡µç‡¥û 8 ‡¥Æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÇ‡¥±‡¥ø‡µΩ ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥Æ‡µÇ‡¥§‡µç‡¥∞‡¥Æ‡µä‡¥¥‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child has normal urine output.",
                "No": "The child has not urinated for over 8 hours, indicating potential dehydration."
            }
        },
    },
    "Breathing Problem": {
        "Q14": {
            "en": "Is the child breathing faster than usual?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥∏‡¥æ‡¥ß‡¥æ‡¥∞‡¥£‡¥Ø‡µá‡¥ï‡µç‡¥ï‡¥æ‡µæ ‡¥µ‡µá‡¥ó‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥∂‡µç‡¥µ‡¥∏‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is showing tachypnea (increased breathing rate).",
                "No": "The child's breathing rate is within the normal range."
            }
        },
        "Q15": {
            "en": "Is the chest pulling in while breathing?",
            "ml": "‡¥∂‡µç‡¥µ‡¥∏‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥Æ‡µç‡¥™‡µã‡µæ ‡¥®‡µÜ‡¥û‡µç‡¥ö‡µç ‡¥â‡¥≥‡µç‡¥≥‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥µ‡¥≤‡¥ø‡¥ï‡µç‡¥ï‡¥™‡µç‡¥™‡µÜ‡¥ü‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child has chest retractions (respiratory distress), where the skin pulls in around the ribs.",
                "No": "The child is breathing easily without visible retractions."
            }
        },
        "Q16": {
            "en": "Are the lips or face turning bluish?",
            "ml": "‡¥ö‡µÅ‡¥£‡µç‡¥ü‡µÅ‡¥ï‡¥≥‡µã ‡¥Æ‡µÅ‡¥ñ‡¥Æ‡µã ‡¥®‡µÄ‡¥≤ ‡¥®‡¥ø‡¥±‡¥§‡µç‡¥§‡¥ø‡¥≤‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "Cyanosis is present: The child's lips or face have a blue tint, indicating low oxygen.",
                "No": "The child has normal skin/lip coloration."
            }
        },
        "Q17": {
            "en": "Is the child unable to speak full sentences due to breathlessness?",
            "ml": "‡¥∂‡µç‡¥µ‡¥æ‡¥∏‡¥Ç ‡¥Æ‡µÅ‡¥ü‡µç‡¥ü‡¥≤‡¥æ‡µΩ ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥™‡µÇ‡µº‡¥£‡µç‡¥£ ‡¥µ‡¥æ‡¥ö‡¥ï‡¥Ç ‡¥™‡¥±‡¥Ø‡¥æ‡¥®‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥ø‡¥≤‡µç‡¥≤‡µá?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is showing severe breathlessness, unable to speak in full sentences.",
                "No": "The child can speak normally without significant shortness of breath."
            }
        },
    },
    "Body Pain / Headache": {
        "Q18": {
            "en": "Is the headache or body pain severe ?",
            "ml": "‡¥§‡¥≤‡¥µ‡µá‡¥¶‡¥®‡¥Ø‡µã ‡¥∂‡¥∞‡µÄ‡¥∞‡¥µ‡µá‡¥¶‡¥®‡¥Ø‡µã ‡¥ï‡µÇ‡¥ü‡µÅ‡¥§‡¥≤‡¥æ‡¥£‡µã ?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is in severe headache or body pain.",
                "No": "The child is experiencing mild to moderate pain."
            }
        },
        "Q20": {
            "en": "Is there repeated vomiting with headache?",
            "ml": "‡¥§‡¥≤‡¥µ‡µá‡¥¶‡¥®‡¥Ø‡µã‡¥ü‡µä‡¥™‡µç‡¥™‡¥Ç ‡¥Ü‡¥µ‡µº‡¥§‡µç‡¥§‡¥ø‡¥ö‡µç‡¥ö ‡¥õ‡µº‡¥¶‡µç‡¥¶‡¥ø‡¥Ø‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child has a headache accompanied by persistent vomiting.",
                "No": "The headache is not associated with vomiting."
            }
        },
        "Q21": {
            "en": "Did the child have a head injury recently?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥ü‡µÅ‡¥§‡µç‡¥§‡¥ø‡¥ü‡µÜ ‡¥§‡¥≤‡¥ï‡µç‡¥ï‡µç ‡¥™‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥£‡µç‡¥ü‡¥æ‡¥Ø‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "There is a history of recent trauma or injury to the head.",
                "No": "There has been no recent head injury."
            }
        },
    },
    "Critical Red-Flags": {
        "Q22": {
            "en": "Has the child had a seizure?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥™‡¥ø‡¥ü‡¥ø‡¥µ‡¥≤‡¥ø ‡¥â‡¥£‡µç‡¥ü‡¥æ‡¥Ø‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child has experienced a seizure or convulsion.",
                "No": "The child has had no seizures."
            }
        },
        "Q23": {
            "en": "Has the child fainted or become unconscious?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥¨‡µã‡¥ß‡¥∞‡¥π‡¥ø‡¥§‡¥®‡¥æ‡¥Ø‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child has experienced loss of consciousness or fainting.",
                "No": "The child has remained conscious throughout."
            }
        },
        "Q24": {
            "en": "Is there a severe injury or heavy bleeding?",
            "ml": "‡¥ó‡µÅ‡¥∞‡µÅ‡¥§‡¥∞‡¥Æ‡¥æ‡¥Ø ‡¥™‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µã ‡¥∞‡¥ï‡µç‡¥§‡¥∏‡µç‡¥∞‡¥æ‡¥µ‡¥Æ‡µã ‡¥â‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child has sustained a major injury or is actively bleeding heavily.",
                "No": "There is no severe injury or heavy bleeding noted."
            }
        },
    }
}

# -----------------------------
# HOME CARE ADVICE LIBRARY
# -----------------------------
HOME_ADVICE_LIBRARY = {
    "REST": {
        "en": "Ensure the child gets adequate rest.",
        "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥§‡µç‡¥§‡¥ø‡¥®‡µç ‡¥µ‡¥ø‡¥∂‡µç‡¥∞‡¥Æ‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï."
    },
    "FLUIDS": {
        "en": "Encourage frequent intake of clean fluids like water or coconut water.",
        "ml": "‡¥µ‡µÜ‡¥≥‡µç‡¥≥‡¥Ç, ‡¥á‡¥≥‡¥®‡µÄ‡µº ‡¥§‡µÅ‡¥ü‡¥ô‡µç‡¥ô‡¥ø‡¥Ø ‡¥™‡¥æ‡¥®‡µÄ‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥ß‡¥æ‡¥∞‡¥æ‡¥≥‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï."
    },
    "LIGHT_DIET": {
        "en": "Provide light, easily digestible food.",
        "ml": "‡¥≤‡¥ò‡µÅ‡¥µ‡¥æ‡¥Ø‡¥§‡µÅ‡¥Ç ‡¥é‡¥≥‡µÅ‡¥™‡µç‡¥™‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥¶‡¥π‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥§‡µÅ‡¥Æ‡¥æ‡¥Ø ‡¥≠‡¥ï‡µç‡¥∑‡¥£‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï."
    },
    "HYGIENE": {
        "en": "Maintain proper hand hygiene to prevent spread of infection.",
        "ml": "‡¥Ö‡¥£‡µÅ‡¥¨‡¥æ‡¥ß ‡¥™‡¥ü‡¥∞‡¥æ‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡µª ‡¥ï‡µà‡¥ï‡µæ ‡¥µ‡µÉ‡¥§‡µç‡¥§‡¥ø‡¥Ø‡¥æ‡¥Ø‡¥ø ‡¥∏‡µÇ‡¥ï‡µç‡¥∑‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."
    },
    "MONITOR_SYMPTOMS": {
        "en": "Monitor symptoms closely for any worsening.",
        "ml": "‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ ‡¥ï‡µÇ‡¥ü‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã ‡¥é‡¥®‡µç‡¥®‡µç ‡¥∂‡µç‡¥∞‡¥¶‡µç‡¥ß‡¥æ‡¥™‡µÇ‡µº‡¥µ‡µç‡¥µ‡¥Ç ‡¥®‡¥ø‡¥∞‡µÄ‡¥ï‡µç‡¥∑‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."
    },
    "TEMPERATURE_CHECK": {
        "en": "Check temperature periodically if fever is present.",
        "ml": "‡¥™‡¥®‡¥ø ‡¥â‡¥£‡µç‡¥ü‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥ï‡µÉ‡¥§‡µç‡¥Ø‡¥∏‡¥Æ‡¥Ø‡¥§‡µç‡¥§‡µç ‡¥§‡¥æ‡¥™‡¥®‡¥ø‡¥≤ ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."
    }
}

# -----------------------------
# HARD RED FLAG CHECK
# -----------------------------
def check_red_flags(answers):
    critical_data = {
        "triage_level": "RED",
        "reasoning": "Immediate medical attention required for life-threatening symptoms flagged by critical clinical rules.",
        "confidence": "High (Rule-based Override)",
        "home_advice": []
    }

    # Rule 1: Direct Critical Questions (Q22, Q23, Q24)
    if any(answers.get(q) == "Yes" for q in ["Q22", "Q23", "Q24"]):
        return critical_data
    # Rule 2: Q3 (Not responding)
    if answers.get("Q3") == "Yes":
        return critical_data
    # Rule 3: Q9 (Fever+Neck Stiffness check)
    if answers.get("Q9") == "Yes" and answers.get("Q6", "") != "<100¬∞F":
        return critical_data
    # Rule 4: Q11 (Blood in vomit/stool)
    if answers.get("Q11") == "Yes":
        return critical_data
    # Rule 5: Q15/Q16 (Chest pulling / Bluish)
    if answers.get("Q15") == "Yes" or answers.get("Q16") == "Yes":
        return critical_data
    # Rule 6: Head injury + Vomiting (Q21 + Q20)
    if answers.get("Q21") == "Yes" and (answers.get("Q20") == "Yes" or answers.get("Q10", "") == "4+"):
        return critical_data
    return None

# -----------------------------
# BUILD STRUCTURED SUMMARY
# -----------------------------
def build_summary(answers):
    summary = "Pediatric Clinical Assessment (Age 6-12):\n"
    for cat, qs in QUESTIONS.items():
        cat_summary = ""
        for q_id, q_data in qs.items():
            val = answers.get(q_id)
            if val is not None:
                # Use context mapping if available
                if "context" in q_data:
                    if callable(q_data["context"]):
                        desc = q_data["context"](val)
                    elif isinstance(q_data["context"], dict):
                        desc = q_data["context"].get(val, f"{q_data['en']}: {val}")
                    else:
                        desc = f"{q_data['en']}: {val}"
                else:
                    desc = f"{q_data['en']}: {val}"
                cat_summary += f"- {desc}\n"

        if cat_summary:
            summary += f"\n### {cat}\n{cat_summary}"
    return summary

# -----------------------------
# MEDGEMMA CLASSIFICATION
# -----------------------------
def classify(summary_text):
    prompt = f"""
You are an expert pediatric triage assistant.
Analyze the following clinical observations for a child aged 6-12 and classify the triage level.

URGENCY LEVELS:
RED ‚Äì Emergency: Immediate hospital/ER required. Life-threatening or unstable symptoms.
YELLOW ‚Äì Urgent: Visit a doctor/clinic within 24 hours. Symptoms are worsening but currently stable.
GREEN ‚Äì Observation: Home care and monitoring. Minor symptoms.

INSTRUCTIONS:
1. Carefully review the "Clinical Observations" provided.
2. Provide your findings in valid JSON format.
3. Select the most relevant advice keys from the ADVICE_LIBRARY below (select 2-3 items).

ADVICE_LIBRARY:
- REST: Ensure the child gets adequate rest.
- FLUIDS: Encourage frequent intake of clean fluids.
- LIGHT_DIET: Provide light, easily digestible food.
- HYGIENE: Maintain proper hand hygiene.
- MONITOR_SYMPTOMS: Monitor symptoms closely for any worsening.
- TEMPERATURE_CHECK: Check temperature periodically if fever is present.

Return format:
{{
  "triage_level": "RED/YELLOW/GREEN",
  "reasoning": "A concise clinical explanation focusing on the severity and combination of symptoms provided.",
  "confidence": "High/Medium/Low",
  "home_advice": ["KEY1", "KEY2"]
}}

Clinical Observations:
{summary_text}
"""
    inputs = tokenizer(prompt, return_tensors="pt").to(device)
    output = model.generate(**inputs, max_new_tokens=400)
    response = tokenizer.decode(output[0], skip_special_tokens=True)

    # Simple JSON extraction in case model adds text before/after
    try:
        json_match = re.search(r'\{.*\}', response, re.DOTALL)
        if json_match:
            return json.loads(json_match.group(0))
        return json.loads(response)
    except:
        # Fallback if AI fails JSON
        return {
            "triage_level": "ERROR",
            "reasoning": f"Failed to parse AI response. Raw output: {response}",
            "confidence": "None"
        }

# -----------------------------
# MALAYALAM OUTPUT FORMATTER
# -----------------------------
def malayalam_output(triage_level):
    if triage_level == "RED":
        return """üî¥ **‡¥Ö‡¥ü‡¥ø‡¥Ø‡¥®‡µç‡¥§‡¥∞ ‡¥ö‡¥ø‡¥ï‡¥ø‡¥§‡µç‡¥∏ ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥Æ‡¥æ‡¥£‡µç (Emergency)**
‡¥â‡¥ü‡µª ‡¥í‡¥∞‡µÅ ‡¥™‡µÄ‡¥°‡¥ø‡¥Ø‡¥æ‡¥ü‡µç‡¥∞‡¥ø‡¥ï‡µç ‡¥Ö‡¥§‡µç‡¥Ø‡¥æ‡¥π‡¥ø‡¥§ ‡¥µ‡¥ø‡¥≠‡¥æ‡¥ó‡¥§‡µç‡¥§‡¥ø‡µΩ (ER) ‡¥é‡¥§‡µç‡¥§‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.
‚ö†Ô∏è ‡¥∂‡µç‡¥µ‡¥æ‡¥∏‡¥Ç ‡¥Æ‡µÅ‡¥ü‡µç‡¥ü‡µΩ, ‡¥¨‡µã‡¥ß‡¥ï‡µç‡¥∑‡¥Ø‡¥Ç, ‡¥ï‡¥†‡¥ø‡¥®‡¥Æ‡¥æ‡¥Ø ‡¥∞‡¥ï‡µç‡¥§‡¥∏‡µç‡¥∞‡¥æ‡¥µ‡¥Ç ‡¥é‡¥®‡µç‡¥®‡¥ø‡¥µ ‡¥â‡¥£‡µç‡¥ü‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥í‡¥ü‡µç‡¥ü‡µÅ‡¥Ç ‡¥µ‡µà‡¥ï‡¥ø‡¥ï‡µç‡¥ï‡¥∞‡µÅ‡¥§‡µç."""
    elif triage_level == "YELLOW":
        return """üü° **‡¥°‡µã‡¥ï‡µç‡¥ü‡¥±‡µÜ ‡¥ï‡¥æ‡¥£‡µÅ‡¥ï (Urgent Care)**
‡¥Ö‡¥ü‡µÅ‡¥§‡µç‡¥§ 24 ‡¥Æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÇ‡¥±‡¥ø‡¥®‡µÅ‡¥≥‡µç‡¥≥‡¥ø‡µΩ ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥°‡µã‡¥ï‡µç‡¥ü‡¥±‡µÜ‡¥Ø‡µã ‡¥Ö‡¥ü‡µÅ‡¥§‡µç‡¥§‡µÅ‡¥≥‡µç‡¥≥ ‡¥ï‡µç‡¥≤‡¥ø‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µã ‡¥∏‡¥®‡µç‡¥¶‡µº‡¥∂‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.
‚ö†Ô∏è ‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ ‡¥ï‡µÇ‡¥ü‡µÅ‡¥ï‡¥Ø‡¥æ‡¥£‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥â‡¥ü‡µª ‡¥Ü‡¥∂‡µÅ‡¥™‡¥§‡µç‡¥∞‡¥ø‡¥Ø‡¥ø‡µΩ ‡¥™‡µã‡¥ï‡µÅ‡¥ï."""
    else:
        return """üü¢ **‡¥µ‡µÄ‡¥ü‡µç‡¥ü‡¥ø‡µΩ ‡¥µ‡¥ø‡¥∂‡µç‡¥∞‡¥Æ‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ç (Home Care)**
‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡µΩ ‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ ‡¥ó‡µÅ‡¥∞‡µÅ‡¥§‡¥∞‡¥Æ‡¥≤‡µç‡¥≤. ‡¥§‡¥æ‡¥¥‡µÜ ‡¥®‡µΩ‡¥ï‡¥ø‡¥Ø‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥® ‡¥®‡¥ø‡µº‡¥¶‡µç‡¥¶‡µá‡¥∂‡¥ô‡µç‡¥ô‡µæ ‡¥™‡¥æ‡¥≤‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.
‚ö†Ô∏è ‡¥™‡¥®‡¥ø ‡¥ï‡µÇ‡¥ü‡µÅ‡¥ï‡¥Ø‡µã ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥Ö‡¥µ‡¥∂‡¥®‡¥æ‡¥ï‡µÅ‡¥ï‡¥Ø‡µã ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥æ‡µΩ ‡¥°‡µã‡¥ï‡µç‡¥ü‡¥±‡µÜ ‡¥∏‡¥Æ‡µÄ‡¥™‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."""

# -----------------------------
# STREAMLIT UI
# -----------------------------
st.set_page_config(page_title="Pediatric Triage", page_icon="üè•", layout="wide")

# Language Selection
st.sidebar.title("Settings")
lang = st.sidebar.radio("Select Language / ‡¥≠‡¥æ‡¥∑ ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï:", ["English", "Malayalam"])
l_key = "en" if lang == "English" else "ml"

st.title("üè• Pediatric Triage System (Age 6‚Äì12)")
st.caption("A tool to help determine the urgency of medical care for children.")

col1, col2 = st.columns([2, 1])

with col1:
    # --- SECTION 1: GENERAL QUESTIONS ---
    with st.expander("General Questions / ‡¥™‡µä‡¥§‡µÅ‡¥µ‡¥æ‡¥Ø ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡µæ", expanded=True):
        answers = {}
        q1 = QUESTIONS["General"]["Q1"]
        answers["Q1"] = st.number_input(q1[l_key], min_value=q1["min"], max_value=q1["max"])

        q2 = QUESTIONS["General"]["Q2"]
        answers["Q2"] = st.radio(
            q2[l_key],
            options=list(q2["options"].keys()),
            format_func=lambda x: q2["options"][x][l_key],
            key="Q2", horizontal=True
        )

        q3 = QUESTIONS["General"]["Q3"]
        answers["Q3"] = st.radio(
            q3[l_key],
            options=list(q3["options"].keys()),
            format_func=lambda x: q3["options"][x][l_key],
            key="Q3", horizontal=True
        )
        if answers["Q3"] == "Yes":
            st.warning("‚ö†Ô∏è High risk flag.")

        q4 = QUESTIONS["General"]["Q4"]
        answers["Q4"] = st.radio(
            q4[l_key],
            options=list(q4["options"].keys()),
            format_func=lambda x: q4["options"][x][l_key],
            key="Q4", horizontal=True
        )

        q5 = QUESTIONS["General"]["Q5"]
        answers["Q5"] = st.radio(
            q5[l_key],
            options=list(q5["options"].keys()),
            format_func=lambda x: q5["options"][x][l_key],
            key="Q5", horizontal=True
        )

    # --- SECTION 2: CATEGORY SELECTION ---
    symptom_cat = st.multiselect(
        "Choose Symptoms / ‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï:",
        ["Cold / Cough / Fever", "Stomach Pain / Diarrhea / Vomiting", "Breathing Problem", "Body Pain / Headache"]
    )

    # --- SECTION 3: DYNAMIC CATEGORY QUESTIONS ---
    for cat in symptom_cat:
        with st.expander(f"{cat}", expanded=True):
            for q_id, q_data in QUESTIONS[cat].items():
                if q_data["type"] == "radio":
                    answers[q_id] = st.radio(
                        q_data[l_key],
                        options=list(q_data["options"].keys()),
                        format_func=lambda x: q_data["options"][x][l_key],
                        key=q_id, horizontal=True
                    )
                    if q_id == "Q9" and answers[q_id] == "Yes":
                        st.warning("‚ö†Ô∏è High risk flag.")
                    if q_id == "Q11" and answers[q_id] == "Yes":
                        st.warning("‚ö†Ô∏è RED Flag.")
                    if q_id in ["Q15", "Q16"] and answers[q_id] == "Yes":
                        st.error("‚ö†Ô∏è Immediate RED Flag.")

    # --- SECTION 4: CRITICAL QUESTIONS (Always Ask) ---
    with st.expander("Critical Conditions / ‡¥ó‡µÅ‡¥∞‡µÅ‡¥§‡¥∞‡¥Æ‡¥æ‡¥Ø ‡¥Ö‡¥µ‡¥∏‡µç‡¥•‡¥ï‡µæ", expanded=True):
        for q_id, q_data in QUESTIONS["Critical Red-Flags"].items():
            answers[q_id] = st.radio(
                q_data[l_key],
                options=list(q_data["options"].keys()),
                format_func=lambda x: q_data["options"][x][l_key],
                key=q_id, horizontal=True
            )

with col2:
    st.subheader("Result / ‡¥´‡¥≤‡¥Ç")
    if st.button("Check Urgency / ‡¥Ö‡¥ü‡¥ø‡¥Ø‡¥®‡µç‡¥§‡¥∞‡¥æ‡¥µ‡¥∏‡µç‡¥• ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï", use_container_width=True):
        with st.spinner("Analyzing..."):
            # 1. Rule-based check
            red_flag_data = check_red_flags(answers)

            if red_flag_data:
                res_json = red_flag_data
            else:
                # 2. AI-based check
                summary = build_summary(answers)
                res_json = classify(summary)

            # Display Triage Advice
            advice_msg = malayalam_output(res_json["triage_level"])
            st.info(advice_msg)

            # Show Home Care Advice if available
            if res_json.get("home_advice"):
                st.subheader("Home Care Advice / ‡¥µ‡µÄ‡¥ü‡µç‡¥ü‡µÅ‡¥ö‡¥ø‡¥ï‡¥ø‡¥§‡µç‡¥∏‡¥æ ‡¥®‡¥ø‡µº‡¥¶‡µç‡¥¶‡µá‡¥∂‡¥ô‡µç‡¥ô‡µæ")
                for key in res_json["home_advice"]:
                    advice_item = HOME_ADVICE_LIBRARY.get(key)
                    if advice_item:
                        st.write(f"- {advice_item[l_key]}")

            # Show Reasoning
            st.divider()
            st.write(f"**Reasoning (English):** {res_json['reasoning']}")
            st.write(f"**Confidence:** {res_json['confidence']}")


            # Show JSON for Storage
            st.divider()
            st.subheader("Storage Data (JSON)")
            st.json(res_json)


st.divider()
st.info("Disclaimer: This tool is for informational purposes only and is not a substitute for professional medical advice, diagnosis, or treatment.")



import streamlit as st
import torch
import json
import re
from transformers import AutoTokenizer, AutoModelForCausalLM

# -----------------------------
# CONFIG
# -----------------------------
MODEL_NAME = "google/medgemma-4b-it"
device = "cuda" if torch.cuda.is_available() else "cpu"

@st.cache_resource
def load_model():
    tokenizer = AutoTokenizer.from_pretrained(MODEL_NAME)
    model = AutoModelForCausalLM.from_pretrained(
        MODEL_NAME,
        torch_dtype=torch.float16 if device == "cuda" else torch.float32,
        device_map="auto"
    )
    return tokenizer, model

tokenizer, model = load_model()

# -----------------------------
# QUESTION DATA STRUCTURE
# -----------------------------
QUESTIONS = {
    "General": {
        "Q1": {
            "en": "What is the child‚Äôs age?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥µ‡¥Ø‡¥∏‡µç ‡¥é‡¥§‡µç‡¥∞‡¥Ø‡¥æ‡¥£‡µç?",
            "type": "number", "min": 6, "max": 12,
            "context": lambda v: f"The child is {v} years old."
        },
        "Q2": {
            "en": "How long has the problem been present?",
            "ml": "‡¥à ‡¥™‡µç‡¥∞‡¥∂‡µç‡¥®‡¥Ç ‡¥é‡¥§‡µç‡¥∞ ‡¥¶‡¥ø‡¥µ‡¥∏‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥§‡µÅ‡¥ü‡¥∞‡µÅ‡¥®‡µç‡¥®‡µÅ?",
            "type": "radio",
            "options": {
                "< 1 day": {"en": "< 1 day", "ml": "1 ‡¥¶‡¥ø‡¥µ‡¥∏‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥§‡¥æ‡¥¥‡µÜ"},
                "1‚Äì2 days": {"en": "1‚Äì2 days", "ml": "1-2 ‡¥¶‡¥ø‡¥µ‡¥∏‡¥Ç"},
                "3+ days": {"en": "3+ days", "ml": "3 ‡¥¶‡¥ø‡¥µ‡¥∏‡¥§‡µç‡¥§‡¥ø‡¥≤‡¥ß‡¥ø‡¥ï‡¥Ç"}
            },
            "context": {
                "< 1 day": "The symptoms started recently (less than 24 hours ago).",
                "1‚Äì2 days": "The symptoms have been present for 1 to 2 days.",
                "3+ days": "The symptoms have persisted for more than 3 days."
            }
        },
        "Q3": {
            "en": "Is the child unusually drowsy, confused, or not responding normally?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥Ö‡¥∏‡¥æ‡¥ß‡¥æ‡¥∞‡¥£‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥â‡¥±‡¥ï‡µç‡¥ï‡¥Æ‡µÅ‡¥≥‡µç‡¥≥‡¥§‡µã ‡¥™‡µç‡¥∞‡¥§‡¥ø‡¥ï‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥§‡µç‡¥§‡¥§‡µã ‡¥Ü‡¥£‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child is showing signs of altered consciousness, unusual drowsiness, or confusion.",
                "No": "The child is alert and responding normally to surroundings."
            }
        },
        "Q4": {
            "en": "Is the child able to drink and keep fluids down?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥µ‡µÜ‡¥≥‡µç‡¥≥‡¥Ç ‡¥ï‡µÅ‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥®‡µÅ‡¥Ç ‡¥®‡¥ø‡¥≤‡¥®‡¥ø‡µº‡¥§‡µç‡¥§‡¥æ‡¥®‡µÅ‡¥Ç ‡¥ï‡¥¥‡¥ø‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is able to tolerate oral fluids and maintain hydration.",
                "No": "The child is unable to drink or keep any fluids down, risking dehydration."
            }
        },
        "Q5": {
            "en": "Does the child have asthma, diabetes, heart disease, or other chronic illness?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥Ü‡¥∏‡µç‡¥§‡µç‡¥Æ, ‡¥™‡µç‡¥∞‡¥Æ‡µá‡¥π‡¥Ç, ‡¥π‡µÉ‡¥¶‡µç‡¥∞‡µã‡¥ó‡¥Ç ‡¥§‡µÅ‡¥ü‡¥ô‡µç‡¥ô‡¥ø‡¥Ø ‡¥¶‡µÄ‡µº‡¥ò‡¥ï‡¥æ‡¥≤ ‡¥∞‡µã‡¥ó‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child has a pre-existing chronic medical condition (e.g., asthma, diabetes).",
                "No": "The child has no known chronic underlying illnesses."
            }
        },
    },
    "Cold / Cough / Fever": {

        "Q6": {
            "en": "How does the fever feel?",
            "ml": "‡¥™‡¥®‡¥ø ‡¥é‡¥ô‡µç‡¥ô‡¥®‡µÜ ‡¥§‡µã‡¥®‡µç‡¥®‡µÅ‡¥®‡µç‡¥®‡µÅ?",
            "type": "radio",
            "options": {
                "Warm but child active": {"en": "Warm but child active", "ml": "‡¥ö‡µÜ‡¥±‡¥ø‡¥Ø ‡¥™‡¥®‡¥ø, ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥â‡¥®‡µç‡¥Æ‡µá‡¥∑‡¥µ‡¥æ‡¥®‡¥æ‡¥£‡µç"},
                "Hot and uncomfortable": {"en": "Hot and uncomfortable", "ml": "‡¥∂‡¥∞‡µÄ‡¥∞‡¥Ç ‡¥®‡¥®‡µç‡¥®‡¥æ‡¥Ø‡¥ø ‡¥ö‡µÇ‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µç, ‡¥Ü‡¥∏‡µç‡¥µ‡¥∏‡µç‡¥•‡¥§‡¥Ø‡µÅ‡¥£‡µç‡¥ü‡µç"},
                "Very hot and child weak": {"en": "Very hot and child weak", "ml": "‡¥ï‡¥†‡¥ø‡¥®‡¥Æ‡¥æ‡¥Ø ‡¥™‡¥®‡¥ø, ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥µ‡¥≥‡¥∞‡µÜ ‡¥Ö‡¥µ‡¥∂‡¥®‡¥æ‡¥£‡µç"}
            },
            "context": {
                "Warm but child active": "Mild fever with normal activity.",
                "Hot and uncomfortable": "Moderate fever.",
                "Very hot and child weak": "High fever affecting the child."
            }
        },
        "Q7": {
            "en": "Has the fever lasted more than 3 days?",
            "ml": "‡¥™‡¥®‡¥ø 3 ‡¥¶‡¥ø‡¥µ‡¥∏‡¥§‡µç‡¥§‡¥ø‡¥≤‡¥ß‡¥ø‡¥ï‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥§‡µÅ‡¥ü‡¥∞‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The fever has been prolonged, lasting more than 72 hours.",
                "No": "The fever is recent and has lasted less than 3 days."
            }
        },
        "Q8": {
            "en": "Is there a rash on the body?",
            "ml": "‡¥∂‡¥∞‡µÄ‡¥∞‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥ö‡µä‡¥±‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥≤‡µã ‡¥ö‡µº‡¥Æ‡µç‡¥Æ‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥™‡¥æ‡¥ü‡µÅ‡¥ï‡¥≥‡µã ‡¥â‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "A new skin rash or spots have appeared on the child's body.",
                "No": "There is no visible rash on the skin."
            }
        },
        "Q9": {
            "en": "Is the child unable to bend the neck forward?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥ï‡¥¥‡µÅ‡¥§‡µç‡¥§‡µç ‡¥Æ‡µÅ‡¥®‡µç‡¥®‡µã‡¥ü‡µç‡¥ü‡µç ‡¥ï‡µÅ‡¥®‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥®‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥ø‡¥≤‡µç‡¥≤‡µá?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child is experiencing neck stiffness (meningismus), unable to touch chin to chest.",
                "No": "The child has normal neck mobility."
            }
        },
    },
    "Stomach Pain / Diarrhea / Vomiting": {
        "Q10": {
            "en": "How many times has the child vomited in the last 24 hours?",
            "ml": "‡¥ï‡¥¥‡¥ø‡¥û‡µç‡¥û 24 ‡¥Æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÇ‡¥±‡¥ø‡µΩ ‡¥é‡¥§‡µç‡¥∞ ‡¥§‡¥µ‡¥£ ‡¥õ‡µº‡¥¶‡µç‡¥¶‡¥ø‡¥ö‡µç‡¥ö‡µÅ?",
            "type": "radio",
            "options": {
                "None": {"en": "None", "ml": "‡¥í‡¥®‡µç‡¥®‡µÅ‡¥Æ‡¥ø‡¥≤‡µç‡¥≤"},
                "1-3": {"en": "1-3", "ml": "1-3 ‡¥§‡¥µ‡¥£"},
                "4+": {"en": "4+", "ml": "4 ‡¥§‡¥µ‡¥£‡¥Ø‡¥ø‡µΩ ‡¥ï‡µÇ‡¥ü‡µÅ‡¥§‡µΩ"}
            },
            "context": {
                "None": "The child has not vomited in the last 24 hours.",
                "1-3": "The child has vomited 1 to 3 times recently.",
                "4+": "The child is experiencing frequent/excessive vomiting (4 or more times)."
            }
        },
        "Q11": {
            "en": "Is there blood in vomit or stool?",
            "ml": "‡¥õ‡µº‡¥¶‡µç‡¥¶‡¥ø‡¥Ø‡¥ø‡¥≤‡µã ‡¥Æ‡¥≤‡¥§‡µç‡¥§‡¥ø‡¥≤‡µã ‡¥∞‡¥ï‡µç‡¥§‡¥Ç ‡¥â‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "Visible blood is present in the child's vomit or bowel movements.",
                "No": "There is no blood observed in vomit or stool."
            }
        },
        "Q12": {
            "en": "Is the stomach pain severe and constant?",
            "ml": "‡¥µ‡¥Ø‡¥±‡µÅ‡¥µ‡µá‡¥¶‡¥® ‡¥ï‡¥†‡¥ø‡¥®‡¥µ‡µÅ‡¥Ç ‡¥∏‡µç‡¥•‡¥ø‡¥∞‡¥µ‡µÅ‡¥Æ‡¥æ‡¥£‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is reporting intense, continuous abdominal pain.",
                "No": "Abdominal pain is absent or only mild/intermittent."
            }
        },
        "Q13": {
            "en": "Has the child passed urine in the last 8 hours?",
            "ml": "‡¥ï‡¥¥‡¥ø‡¥û‡µç‡¥û 8 ‡¥Æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÇ‡¥±‡¥ø‡µΩ ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥Æ‡µÇ‡¥§‡µç‡¥∞‡¥Æ‡µä‡¥¥‡¥ø‡¥ö‡µç‡¥ö‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child has normal urine output.",
                "No": "The child has not urinated for over 8 hours, indicating potential dehydration."
            }
        },
    },
    "Breathing Problem": {
        "Q14": {
            "en": "Is the child breathing faster than usual?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥∏‡¥æ‡¥ß‡¥æ‡¥∞‡¥£‡¥Ø‡µá‡¥ï‡µç‡¥ï‡¥æ‡µæ ‡¥µ‡µá‡¥ó‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥∂‡µç‡¥µ‡¥∏‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is showing tachypnea (increased breathing rate).",
                "No": "The child's breathing rate is within the normal range."
            }
        },
        "Q15": {
            "en": "Is the chest pulling in while breathing?",
            "ml": "‡¥∂‡µç‡¥µ‡¥∏‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥Æ‡µç‡¥™‡µã‡µæ ‡¥®‡µÜ‡¥û‡µç‡¥ö‡µç ‡¥â‡¥≥‡µç‡¥≥‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥µ‡¥≤‡¥ø‡¥ï‡µç‡¥ï‡¥™‡µç‡¥™‡µÜ‡¥ü‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child has chest retractions (respiratory distress), where the skin pulls in around the ribs.",
                "No": "The child is breathing easily without visible retractions."
            }
        },
        "Q16": {
            "en": "Are the lips or face turning bluish?",
            "ml": "‡¥ö‡µÅ‡¥£‡µç‡¥ü‡µÅ‡¥ï‡¥≥‡µã ‡¥Æ‡µÅ‡¥ñ‡¥Æ‡µã ‡¥®‡µÄ‡¥≤ ‡¥®‡¥ø‡¥±‡¥§‡µç‡¥§‡¥ø‡¥≤‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "Cyanosis is present: The child's lips or face have a blue tint, indicating low oxygen.",
                "No": "The child has normal skin/lip coloration."
            }
        },
        "Q17": {
            "en": "Is the child unable to speak full sentences due to breathlessness?",
            "ml": "‡¥∂‡µç‡¥µ‡¥æ‡¥∏‡¥Ç ‡¥Æ‡µÅ‡¥ü‡µç‡¥ü‡¥≤‡¥æ‡µΩ ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥™‡µÇ‡µº‡¥£‡µç‡¥£ ‡¥µ‡¥æ‡¥ö‡¥ï‡¥Ç ‡¥™‡¥±‡¥Ø‡¥æ‡¥®‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥ø‡¥≤‡µç‡¥≤‡µá?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is showing severe breathlessness, unable to speak in full sentences.",
                "No": "The child can speak normally without significant shortness of breath."
            }
        },
    },
    "Body Pain / Headache": {
        "Q18": {
            "en": "Is the headache or body pain severe ?",
            "ml": "‡¥§‡¥≤‡¥µ‡µá‡¥¶‡¥®‡¥Ø‡µã ‡¥∂‡¥∞‡µÄ‡¥∞‡¥µ‡µá‡¥¶‡¥®‡¥Ø‡µã ‡¥ï‡µÇ‡¥ü‡µÅ‡¥§‡¥≤‡¥æ‡¥£‡µã ?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child is in severe headache or body pain.",
                "No": "The child is experiencing mild to moderate pain."
            }
        },
        "Q20": {
            "en": "Is there repeated vomiting with headache?",
            "ml": "‡¥§‡¥≤‡¥µ‡µá‡¥¶‡¥®‡¥Ø‡µã‡¥ü‡µä‡¥™‡µç‡¥™‡¥Ç ‡¥Ü‡¥µ‡µº‡¥§‡µç‡¥§‡¥ø‡¥ö‡µç‡¥ö ‡¥õ‡µº‡¥¶‡µç‡¥¶‡¥ø‡¥Ø‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "The child has a headache accompanied by persistent vomiting.",
                "No": "The headache is not associated with vomiting."
            }
        },
        "Q21": {
            "en": "Did the child have a head injury recently?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥ü‡µÅ‡¥§‡µç‡¥§‡¥ø‡¥ü‡µÜ ‡¥§‡¥≤‡¥ï‡µç‡¥ï‡µç ‡¥™‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥£‡µç‡¥ü‡¥æ‡¥Ø‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "context": {
                "Yes": "There is a history of recent trauma or injury to the head.",
                "No": "There has been no recent head injury."
            }
        },
    },
    "Critical Red-Flags": {
        "Q22": {
            "en": "Has the child had a seizure?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥™‡¥ø‡¥ü‡¥ø‡¥µ‡¥≤‡¥ø ‡¥â‡¥£‡µç‡¥ü‡¥æ‡¥Ø‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child has experienced a seizure or convulsion.",
                "No": "The child has had no seizures."
            }
        },
        "Q23": {
            "en": "Has the child fainted or become unconscious?",
            "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥¨‡µã‡¥ß‡¥∞‡¥π‡¥ø‡¥§‡¥®‡¥æ‡¥Ø‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child has experienced loss of consciousness or fainting.",
                "No": "The child has remained conscious throughout."
            }
        },
        "Q24": {
            "en": "Is there a severe injury or heavy bleeding?",
            "ml": "‡¥ó‡µÅ‡¥∞‡µÅ‡¥§‡¥∞‡¥Æ‡¥æ‡¥Ø ‡¥™‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µã ‡¥∞‡¥ï‡µç‡¥§‡¥∏‡µç‡¥∞‡¥æ‡¥µ‡¥Æ‡µã ‡¥â‡¥£‡µç‡¥ü‡µã?",
            "type": "radio",
            "options": {"Yes": {"en": "Yes", "ml": "‡¥Ö‡¥§‡µÜ"}, "No": {"en": "No", "ml": "‡¥Ö‡¥≤‡µç‡¥≤"}},
            "is_critical": True,
            "context": {
                "Yes": "The child has sustained a major injury or is actively bleeding heavily.",
                "No": "There is no severe injury or heavy bleeding noted."
            }
        },
    }
}

# -----------------------------
# HOME CARE ADVICE LIBRARY
# -----------------------------
HOME_ADVICE_LIBRARY = {
    "REST": {
        "en": "Ensure the child gets adequate rest.",
        "ml": "‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥§‡µç‡¥§‡¥ø‡¥®‡µç ‡¥µ‡¥ø‡¥∂‡µç‡¥∞‡¥Æ‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï."
    },
    "FLUIDS": {
        "en": "Encourage frequent intake of clean fluids like water or coconut water.",
        "ml": "‡¥µ‡µÜ‡¥≥‡µç‡¥≥‡¥Ç, ‡¥á‡¥≥‡¥®‡µÄ‡µº ‡¥§‡µÅ‡¥ü‡¥ô‡µç‡¥ô‡¥ø‡¥Ø ‡¥™‡¥æ‡¥®‡µÄ‡¥Ø‡¥ô‡µç‡¥ô‡µæ ‡¥ß‡¥æ‡¥∞‡¥æ‡¥≥‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï."
    },
    "LIGHT_DIET": {
        "en": "Provide light, easily digestible food.",
        "ml": "‡¥≤‡¥ò‡µÅ‡¥µ‡¥æ‡¥Ø‡¥§‡µÅ‡¥Ç ‡¥é‡¥≥‡µÅ‡¥™‡µç‡¥™‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥¶‡¥π‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥§‡µÅ‡¥Æ‡¥æ‡¥Ø ‡¥≠‡¥ï‡µç‡¥∑‡¥£‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï."
    },
    "HYGIENE": {
        "en": "Maintain proper hand hygiene to prevent spread of infection.",
        "ml": "‡¥Ö‡¥£‡µÅ‡¥¨‡¥æ‡¥ß ‡¥™‡¥ü‡¥∞‡¥æ‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡µª ‡¥ï‡µà‡¥ï‡µæ ‡¥µ‡µÉ‡¥§‡µç‡¥§‡¥ø‡¥Ø‡¥æ‡¥Ø‡¥ø ‡¥∏‡µÇ‡¥ï‡µç‡¥∑‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."
    },
    "MONITOR_SYMPTOMS": {
        "en": "Monitor symptoms closely for any worsening.",
        "ml": "‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ ‡¥ï‡µÇ‡¥ü‡µÅ‡¥®‡µç‡¥®‡µÅ‡¥£‡µç‡¥ü‡µã ‡¥é‡¥®‡µç‡¥®‡µç ‡¥∂‡µç‡¥∞‡¥¶‡µç‡¥ß‡¥æ‡¥™‡µÇ‡µº‡¥µ‡µç‡¥µ‡¥Ç ‡¥®‡¥ø‡¥∞‡µÄ‡¥ï‡µç‡¥∑‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."
    },
    "TEMPERATURE_CHECK": {
        "en": "Check temperature periodically if fever is present.",
        "ml": "‡¥™‡¥®‡¥ø ‡¥â‡¥£‡µç‡¥ü‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥ï‡µÉ‡¥§‡µç‡¥Ø‡¥∏‡¥Æ‡¥Ø‡¥§‡µç‡¥§‡µç ‡¥§‡¥æ‡¥™‡¥®‡¥ø‡¥≤ ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."
    }
}

# -----------------------------
# HARD RED FLAG CHECK
# -----------------------------
def check_red_flags(answers):
    critical_data = {
        "triage_level": "RED",
        "reasoning": "Immediate medical attention required for life-threatening symptoms flagged by critical clinical rules.",
        "confidence": "High (Rule-based Override)",
        "home_advice": []
    }

    # Rule 1: Direct Critical Questions (Q22, Q23, Q24)
    if any(answers.get(q) == "Yes" for q in ["Q22", "Q23", "Q24"]):
        return critical_data
    # Rule 2: Q3 (Not responding)
    if answers.get("Q3") == "Yes":
        return critical_data
    # Rule 3: Q9 (Fever+Neck Stiffness check)
    if answers.get("Q9") == "Yes" and answers.get("Q6") is not None:
        return critical_data
    # Rule 4: Q11 (Blood in vomit/stool)
    if answers.get("Q11") == "Yes":
        return critical_data
    # Rule 5: Q15/Q16 (Chest pulling / Bluish)
    if answers.get("Q15") == "Yes" or answers.get("Q16") == "Yes":
        return critical_data
    # Rule 6: Head injury + Vomiting (Q21 + Q20)
    if answers.get("Q21") == "Yes" and (answers.get("Q20") == "Yes" or answers.get("Q10", "") == "4+"):
        return critical_data
    return None

# -----------------------------
# BUILD STRUCTURED SUMMARY
# -----------------------------
def build_summary(answers):
    summary = "Pediatric Clinical Assessment (Age 6-12):\n"
    for cat, qs in QUESTIONS.items():
        cat_summary = ""
        for q_id, q_data in qs.items():
            val = answers.get(q_id)
            if val is not None:
                # Use context mapping if available
                if "context" in q_data:
                    if callable(q_data["context"]):
                        desc = q_data["context"](val)
                    elif isinstance(q_data["context"], dict):
                        desc = q_data["context"].get(val, f"{q_data['en']}: {val}")
                    else:
                        desc = f"{q_data['en']}: {val}"
                else:
                    desc = f"{q_data['en']}: {val}"
                cat_summary += f"- {desc}\n"

        if cat_summary:
            summary += f"\n### {cat}\n{cat_summary}"
    return summary

# -----------------------------
# MEDGEMMA CLASSIFICATION
# -----------------------------
def classify(summary_text):
    prompt = f"""<start_of_turn>user
You are an expert pediatric triage assistant.
Analyze the following clinical observations for a child aged 6-12 and classify the triage level.

URGENCY LEVELS:
RED ‚Äì Emergency: Immediate hospital/ER required. Life-threatening or unstable symptoms.
YELLOW ‚Äì Urgent: Visit a doctor/clinic within 24 hours. Symptoms are worsening but currently stable.
GREEN ‚Äì Observation: Home care and monitoring. Minor symptoms.

INSTRUCTIONS:
1. Carefully review the "Clinical Observations" provided.
2. Provide your findings in valid JSON format.
3. Select the most relevant advice keys from the ADVICE_LIBRARY below (select 2-3 items).

ADVICE_LIBRARY:
- REST: Ensure the child gets adequate rest.
- FLUIDS: Encourage frequent intake of clean fluids.
- LIGHT_DIET: Provide light, easily digestible food.
- HYGIENE: Maintain proper hand hygiene.
- MONITOR_SYMPTOMS: Monitor symptoms closely for any worsening.
- TEMPERATURE_CHECK: Check temperature periodically if fever is present.

Return format:
{{
  "triage_level": "RED/YELLOW/GREEN",
  "reasoning": "A concise clinical explanation focusing on the severity and combination of symptoms provided.",
  "confidence": "High/Medium/Low",
  "home_advice": ["KEY1", "KEY2"]
}}

Clinical Observations:
{summary_text}<end_of_turn>
<start_of_turn>model
"""
    inputs = tokenizer(prompt, return_tensors="pt").to(device)
    output = model.generate(**inputs, max_new_tokens=400)
    response = tokenizer.decode(output[0], skip_special_tokens=True)

    # Simple JSON extraction in case model adds text before/after
    try:
        json_match = re.search(r'\{.*\}', response, re.DOTALL)
        if json_match:
            return json.loads(json_match.group(0))
        return json.loads(response)
    except:
        # Fallback if AI fails JSON
        return {
            "triage_level": "ERROR",
            "reasoning": f"Failed to parse AI response. Raw output: {response}",
            "confidence": "None"
        }

# -----------------------------
# MALAYALAM OUTPUT FORMATTER
# -----------------------------
def malayalam_output(triage_level):
    if triage_level == "RED":
        return """üî¥ **‡¥Ö‡¥ü‡¥ø‡¥Ø‡¥®‡µç‡¥§‡¥∞ ‡¥ö‡¥ø‡¥ï‡¥ø‡¥§‡µç‡¥∏ ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥Æ‡¥æ‡¥£‡µç (Emergency)**
‡¥â‡¥ü‡µª ‡¥í‡¥∞‡µÅ ‡¥™‡µÄ‡¥°‡¥ø‡¥Ø‡¥æ‡¥ü‡µç‡¥∞‡¥ø‡¥ï‡µç ‡¥Ö‡¥§‡µç‡¥Ø‡¥æ‡¥π‡¥ø‡¥§ ‡¥µ‡¥ø‡¥≠‡¥æ‡¥ó‡¥§‡µç‡¥§‡¥ø‡µΩ (ER) ‡¥é‡¥§‡µç‡¥§‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.
‚ö†Ô∏è ‡¥∂‡µç‡¥µ‡¥æ‡¥∏‡¥Ç ‡¥Æ‡µÅ‡¥ü‡µç‡¥ü‡µΩ, ‡¥¨‡µã‡¥ß‡¥ï‡µç‡¥∑‡¥Ø‡¥Ç, ‡¥ï‡¥†‡¥ø‡¥®‡¥Æ‡¥æ‡¥Ø ‡¥∞‡¥ï‡µç‡¥§‡¥∏‡µç‡¥∞‡¥æ‡¥µ‡¥Ç ‡¥é‡¥®‡µç‡¥®‡¥ø‡¥µ ‡¥â‡¥£‡µç‡¥ü‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥í‡¥ü‡µç‡¥ü‡µÅ‡¥Ç ‡¥µ‡µà‡¥ï‡¥ø‡¥ï‡µç‡¥ï‡¥∞‡µÅ‡¥§‡µç."""
    elif triage_level == "YELLOW":
        return """üü° **‡¥°‡µã‡¥ï‡µç‡¥ü‡¥±‡µÜ ‡¥ï‡¥æ‡¥£‡µÅ‡¥ï (Urgent Care)**
‡¥Ö‡¥ü‡µÅ‡¥§‡µç‡¥§ 24 ‡¥Æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÇ‡¥±‡¥ø‡¥®‡µÅ‡¥≥‡µç‡¥≥‡¥ø‡µΩ ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥°‡µã‡¥ï‡µç‡¥ü‡¥±‡µÜ‡¥Ø‡µã ‡¥Ö‡¥ü‡µÅ‡¥§‡µç‡¥§‡µÅ‡¥≥‡µç‡¥≥ ‡¥ï‡µç‡¥≤‡¥ø‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µã ‡¥∏‡¥®‡µç‡¥¶‡µº‡¥∂‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.
‚ö†Ô∏è ‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ ‡¥ï‡µÇ‡¥ü‡µÅ‡¥ï‡¥Ø‡¥æ‡¥£‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥â‡¥ü‡µª ‡¥Ü‡¥∂‡µÅ‡¥™‡¥§‡µç‡¥∞‡¥ø‡¥Ø‡¥ø‡µΩ ‡¥™‡µã‡¥ï‡µÅ‡¥ï."""
    elif triage_level == "GREEN":
        return """üü¢ **‡¥µ‡µÄ‡¥ü‡µç‡¥ü‡¥ø‡µΩ ‡¥µ‡¥ø‡¥∂‡µç‡¥∞‡¥Æ‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ç (Home Care)**
‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡µΩ ‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ ‡¥ó‡µÅ‡¥∞‡µÅ‡¥§‡¥∞‡¥Æ‡¥≤‡µç‡¥≤. ‡¥§‡¥æ‡¥¥‡µÜ ‡¥®‡µΩ‡¥ï‡¥ø‡¥Ø‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥® ‡¥®‡¥ø‡µº‡¥¶‡µç‡¥¶‡µá‡¥∂‡¥ô‡µç‡¥ô‡µæ ‡¥™‡¥æ‡¥≤‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï.
‚ö†Ô∏è ‡¥™‡¥®‡¥ø ‡¥ï‡µÇ‡¥ü‡µÅ‡¥ï‡¥Ø‡µã ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥Ö‡¥µ‡¥∂‡¥®‡¥æ‡¥ï‡µÅ‡¥ï‡¥Ø‡µã ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥æ‡µΩ ‡¥°‡µã‡¥ï‡µç‡¥ü‡¥±‡µÜ ‡¥∏‡¥Æ‡µÄ‡¥™‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."""
    else:
        return """‚ö†Ô∏è **‡¥∏‡¥æ‡¥ô‡µç‡¥ï‡µá‡¥§‡¥ø‡¥ï ‡¥§‡¥ï‡¥∞‡¥æ‡µº (System Error)**
‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥µ‡¥ø‡¥∂‡¥ï‡¥≤‡¥®‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡µª ‡¥á‡¥™‡µç‡¥™‡µã‡µæ ‡¥∏‡¥æ‡¥ß‡µç‡¥Ø‡¥Æ‡¥æ‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥ø‡¥≤‡µç‡¥≤. ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥∏‡µç‡¥µ‡¥æ‡¥∏‡µç‡¥•‡µç‡¥Ø‡¥Æ‡µÅ‡¥£‡µç‡¥ü‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥¶‡¥Ø‡¥µ‡¥æ‡¥Ø‡¥ø ‡¥í‡¥∞‡µÅ ‡¥°‡µã‡¥ï‡µç‡¥ü‡¥±‡µÜ ‡¥∏‡¥Æ‡µÄ‡¥™‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."""

# -----------------------------
# STREAMLIT UI
# -----------------------------
st.set_page_config(page_title="Pediatric Triage", page_icon="üè•", layout="wide")

# Language Selection
st.sidebar.title("Settings")
lang = st.sidebar.radio("Select Language / ‡¥≠‡¥æ‡¥∑ ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï:", ["English", "Malayalam"])
l_key = "en" if lang == "English" else "ml"

st.title("üè• Pediatric Triage System (Age 6‚Äì12)")
st.caption("A tool to help determine the urgency of medical care for children.")

col1, col2 = st.columns([2, 1])

with col1:
    # --- SECTION 1: GENERAL QUESTIONS ---
    with st.expander("General Questions / ‡¥™‡µä‡¥§‡µÅ‡¥µ‡¥æ‡¥Ø ‡¥ö‡µã‡¥¶‡µç‡¥Ø‡¥ô‡µç‡¥ô‡µæ", expanded=True):
        answers = {}
        q1 = QUESTIONS["General"]["Q1"]
        answers["Q1"] = st.number_input(q1[l_key], min_value=q1["min"], max_value=q1["max"])

        q2 = QUESTIONS["General"]["Q2"]
        answers["Q2"] = st.radio(
            q2[l_key],
            options=list(q2["options"].keys()),
            format_func=lambda x: q2["options"][x][l_key],
            key="Q2", horizontal=True
        )

        q3 = QUESTIONS["General"]["Q3"]
        answers["Q3"] = st.radio(
            q3[l_key],
            options=list(q3["options"].keys()),
            format_func=lambda x: q3["options"][x][l_key],
            key="Q3", horizontal=True
        )
        if answers["Q3"] == "Yes":
            st.warning("‚ö†Ô∏è High risk flag.")

        q4 = QUESTIONS["General"]["Q4"]
        answers["Q4"] = st.radio(
            q4[l_key],
            options=list(q4["options"].keys()),
            format_func=lambda x: q4["options"][x][l_key],
            key="Q4", horizontal=True
        )

        q5 = QUESTIONS["General"]["Q5"]
        answers["Q5"] = st.radio(
            q5[l_key],
            options=list(q5["options"].keys()),
            format_func=lambda x: q5["options"][x][l_key],
            key="Q5", horizontal=True
        )

    # --- SECTION 2: CATEGORY SELECTION ---
    symptom_cat = st.multiselect(
        "Choose Symptoms / ‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ ‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï:",
        ["Cold / Cough / Fever", "Stomach Pain / Diarrhea / Vomiting", "Breathing Problem", "Body Pain / Headache"]
    )

    # --- SECTION 3: DYNAMIC CATEGORY QUESTIONS ---
    for cat in symptom_cat:
        with st.expander(f"{cat}", expanded=True):
            for q_id, q_data in QUESTIONS[cat].items():
                if q_data["type"] == "radio":
                    answers[q_id] = st.radio(
                        q_data[l_key],
                        options=list(q_data["options"].keys()),
                        format_func=lambda x: q_data["options"][x][l_key],
                        key=q_id, horizontal=True
                    )
                    if q_id == "Q9" and answers[q_id] == "Yes":
                        st.warning("‚ö†Ô∏è High risk flag.")
                    if q_id == "Q11" and answers[q_id] == "Yes":
                        st.warning("‚ö†Ô∏è RED Flag.")
                    if q_id in ["Q15", "Q16"] and answers[q_id] == "Yes":
                        st.error("‚ö†Ô∏è Immediate RED Flag.")

    # --- SECTION 4: CRITICAL QUESTIONS (Always Ask) ---
    with st.expander("Critical Conditions / ‡¥ó‡µÅ‡¥∞‡µÅ‡¥§‡¥∞‡¥Æ‡¥æ‡¥Ø ‡¥Ö‡¥µ‡¥∏‡µç‡¥•‡¥ï‡µæ", expanded=True):
        for q_id, q_data in QUESTIONS["Critical Red-Flags"].items():
            answers[q_id] = st.radio(
                q_data[l_key],
                options=list(q_data["options"].keys()),
                format_func=lambda x: q_data["options"][x][l_key],
                key=q_id, horizontal=True
            )

with col2:
    st.subheader("Result / ‡¥´‡¥≤‡¥Ç")
    if st.button("Check Urgency / ‡¥Ö‡¥ü‡¥ø‡¥Ø‡¥®‡µç‡¥§‡¥∞‡¥æ‡¥µ‡¥∏‡µç‡¥• ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï", use_container_width=True):
        with st.spinner("Analyzing..."):
            # 1. Rule-based check
            red_flag_data = check_red_flags(answers)

            if red_flag_data:
                res_json = red_flag_data
            else:
                # 2. AI-based check
                summary = build_summary(answers)
                res_json = classify(summary)

            # Display Triage Advice
            advice_msg = malayalam_output(res_json["triage_level"])
            st.info(advice_msg)

            # Show Home Care Advice if available
            if res_json.get("home_advice"):
                st.subheader("Home Care Advice / ‡¥µ‡µÄ‡¥ü‡µç‡¥ü‡µÅ‡¥ö‡¥ø‡¥ï‡¥ø‡¥§‡µç‡¥∏‡¥æ ‡¥®‡¥ø‡µº‡¥¶‡µç‡¥¶‡µá‡¥∂‡¥ô‡µç‡¥ô‡µæ")
                for key in res_json["home_advice"]:
                    advice_item = HOME_ADVICE_LIBRARY.get(key)
                    if advice_item:
                        st.write(f"- {advice_item[l_key]}")

            # Show Reasoning
            st.divider()
            st.write(f"**Reasoning (English):** {res_json['reasoning']}")
            st.write(f"**Confidence:** {res_json['confidence']}")


            # Show JSON for Storage
            st.divider()
            st.subheader("Storage Data (JSON)")
            st.json(res_json)


st.divider()
st.info("Disclaimer: This tool is for informational purposes only and is not a substitute for professional medical advice, diagnosis, or treatment.")